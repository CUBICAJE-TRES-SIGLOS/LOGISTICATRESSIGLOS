<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Borrador - Hoja libre de carga</title>
		<style>
			:root {
				color-scheme: light;
				--bg: #f7f9fc;
				--paper-line: rgba(37, 99, 235, 0.12);
				--paper-shadow: rgba(15, 23, 42, 0.04);
				--card: #ffffff;
				--text: #0f172a;
				--muted: #64748b;
				--border: #e2e8f0;
				--accent: #2563eb;
				--accent-2: #0ea5e9;
			}

			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
				font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
			}

			body {
				background-color: var(--bg);
				background-image: linear-gradient(
						0deg,
						transparent 31px,
						var(--paper-line) 31px,
						var(--paper-line) 32px,
						transparent 32px
					),
					linear-gradient(180deg, var(--paper-shadow), transparent 120px);
				background-size: 100% 32px, 100% 100%;
				background-attachment: fixed;
				color: var(--text);
				padding: 32px 24px 48px;
			}

			header {
				display: flex;
				flex-direction: column;
				gap: 12px;
				margin-bottom: 24px;
			}

			header h1 {
				font-size: 28px;
				font-weight: 700;
			}

			.subline {
				display: flex;
				flex-wrap: wrap;
				align-items: center;
				gap: 16px;
				color: var(--muted);
				font-size: 14px;
			}

			.badge {
				background: rgba(37, 99, 235, 0.1);
				color: var(--accent);
				padding: 6px 12px;
				border-radius: 999px;
				font-weight: 600;
			}

			.actions {
				display: flex;
				flex-wrap: wrap;
				gap: 12px;
				margin-top: 8px;
			}

			.actions .search-field {
				min-width: 200px;
				max-width: 240px;
			}

			.tabs {
				display: inline-flex;
				gap: 8px;
				background: #fff;
				border: 1px solid var(--border);
				border-radius: 999px;
				padding: 4px;
				width: fit-content;
			}

			.tab-button {
				border: none;
				background: transparent;
				padding: 8px 16px;
				border-radius: 999px;
				font-weight: 600;
				color: var(--muted);
				cursor: pointer;
			}

			.tab-button.active {
				background: rgba(37, 99, 235, 0.12);
				color: var(--accent);
			}

			button {
				border: none;
				border-radius: 10px;
				padding: 10px 16px;
				font-size: 14px;
				font-weight: 600;
				cursor: pointer;
				transition: transform 0.1s ease, box-shadow 0.2s ease;
			}

			button.primary {
				background: var(--accent);
				color: #fff;
				box-shadow: 0 8px 16px rgba(37, 99, 235, 0.2);
			}

			button.secondary {
				background: #fff;
				color: var(--accent);
				border: 1px solid var(--border);
			}

			button:active {
				transform: scale(0.98);
			}

			.table-card {
				background: var(--card);
				border: 1px solid var(--border);
				border-radius: 16px;
				padding: 16px;
				box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
				overflow: hidden;
			}

			.table-wrap {
				overflow-x: auto;
				padding-bottom: 8px;
			}

			table {
				width: 100%;
				border-collapse: collapse;
				min-width: 1200px;
			}

			thead th {
				position: sticky;
				top: 0;
				background: #f8fafc;
				color: var(--muted);
				font-size: 12px;
				text-transform: uppercase;
				letter-spacing: 0.04em;
				padding: 12px 10px;
				border-bottom: 1px solid var(--border);
			}

			tbody td {
				border-bottom: 1px solid var(--border);
				padding: 10px;
				vertical-align: top;
			}

			tbody tr:hover {
				background: #f1f5f9;
			}

			tbody tr.unit-group {
				background: rgba(251, 191, 36, 0.18);
				box-shadow: inset 6px 0 0 rgba(245, 158, 11, 0.95);
			}

			tbody tr.unit-group-alt {
				background: rgba(74, 222, 128, 0.18);
				box-shadow: inset 6px 0 0 rgba(34, 197, 94, 0.95);
			}

			input[type="text"],
			input[type="number"],
			input[type="datetime-local"],
			select {
				width: 100%;
				border: 1px solid var(--border);
				border-radius: 8px;
				padding: 8px 10px;
				font-size: 14px;
				background: #fff;
				color: var(--text);
			}

			input[readonly] {
				background: #f8fafc;
				font-weight: 600;
			}

			input[type="number"] {
				text-align: center;
			}

			.row-actions {
				display: flex;
				gap: 8px;
			}

			.row-actions button {
				padding: 6px 10px;
				font-size: 12px;
				border-radius: 8px;
			}

			.row-actions .danger {
				background: #fee2e2;
				color: #b91c1c;
			}

			.hidden-column {
				display: none;
			}

			.footer-note {
				margin-top: 12px;
				font-size: 12px;
				color: var(--muted);
			}

			.tab-section {
				display: none;
			}

			.tab-section.active {
				display: block;
			}

			.logistica-table th,
			.logistica-table td {
				white-space: normal;
				vertical-align: top;
				padding: 8px 10px;
			}

			.accordion-item {
				border: 1px solid var(--border);
				border-radius: 12px;
				background: #fff;
				padding: 10px 14px;
				box-shadow: 0 8px 20px rgba(15, 23, 42, 0.05);
			}

			.accordion-item summary {
				cursor: pointer;
				font-weight: 700;
				list-style: none;
				display: flex;
				align-items: center;
				justify-content: space-between;
				gap: 12px;
			}

			.accordion-item summary::after {
				content: "v";
				font-weight: 700;
				color: var(--muted);
				transition: transform 0.2s ease;
			}

			.accordion-item[open] summary::after {
				transform: rotate(180deg);
			}

			.accordion-item summary::-webkit-details-marker {
				display: none;
			}

			.accordion-summary {
				display: flex;
				flex-wrap: wrap;
				gap: 8px;
				color: var(--text);
				font-size: 14px;
			}

			.accordion-chip {
				background: #f1f5f9;
				border-radius: 999px;
				padding: 4px 10px;
				font-size: 12px;
				color: var(--muted);
			}

			.accordion-content {
				margin-top: 10px;
				display: grid;
				gap: 6px;
			}

			.accordion-empty {
				border: 1px dashed var(--border);
				border-radius: 12px;
				padding: 16px;
				color: var(--muted);
				text-align: center;
			}

			.logistica-table thead th[data-column] {
				cursor: pointer;
			}

			.logistica-table .col-destino {
				max-width: 220px;
				width: 220px;
			}

			.logistica-table .col-fecha {
				max-width: 70px;
				width: 70px;
				white-space: nowrap;
			}

			.logistica-table input[type="text"] {
				min-width: 150px;
			}

			.logistica-table textarea {
				width: 100%;
				min-height: 36px;
				border: 1px solid var(--border);
				border-radius: 8px;
				padding: 6px 8px;
				font-size: 14px;
				background: #fff;
				color: var(--text);
				resize: none;
				overflow: hidden;
			}

			.logistica-table input[type="text"],
			.logistica-table input[type="number"] {
				padding: 6px 8px;
			}

			@media print {
				@page {
					size: A4 portrait;
					margin: 6mm;
				}

				body {
					background: #fff;
					padding: 0;
				}

				header,
				#borradorSection,
				#logisticaActions,
				.footer-note {
					display: none !important;
				}

				#logisticaSection {
					display: block !important;
				}

				#logisticaAccordion {
					display: block !important;
				}

				#logisticaAccordion > summary {
					display: none !important;
				}

				#logisticaAccordion > .accordion-content {
					display: block !important;
				}

				.table-card {
					box-shadow: none;
					border: none;
				}

				.table-wrap {
					overflow: visible;
				}

				.logistica-table {
					width: 100% !important;
					min-width: 100% !important;
					font-size: 13.5px;
					table-layout: auto;
				}

				.logistica-table thead th {
					font-size: 12px;
					padding: 0;
					line-height: 1;
				}

				.logistica-table th,
				.logistica-table td {
					padding: 0;
					line-height: 1;
					white-space: normal;
					word-break: break-word;
					overflow-wrap: anywhere;
				}

				.logistica-table .col-fecha {
					width: 60px;
					max-width: 60px;
					white-space: nowrap;
				}

				.logistica-table .print-hide {
					display: none !important;
				}

				.logistica-table .col-fecha {
					display: none !important;
				}

				.logistica-table input {
					border: none;
					padding: 0;
					margin: 0;
					box-shadow: none;
					background: transparent;
					font-size: 13.5px;
					line-height: 1;
					height: auto !important;
					width: 100%;
				}

				.logistica-table textarea {
					border: none;
					padding: 0;
					margin: 0;
					box-shadow: none;
					background: transparent;
					font-size: 13.5px;
					line-height: 1;
					height: auto !important;
					width: 100%;
					min-height: 0;
					resize: none;
					overflow: visible;
				}

				.hidden-column {
					display: none !important;
				}

				.print-hide {
					display: none !important;
				}
			}
		</style>
	</head>
	<body>
		<header>
			<h1>Borrador - Hoja libre de carga</h1>
			<div class="subline">
				<span class="badge" id="currentDate">Fecha:</span>
				<span>Todos los campos se pueden editar.</span>
			</div>
			<div class="tabs">
				<button class="tab-button active" id="tabBorrador">Borrador</button>
				<button class="tab-button" id="tabLogistica">Logística del día</button>
			</div>
			<div class="actions">
				<button class="primary" id="addRow">Agregar fila</button>
				<button class="secondary" id="saveDraft">Guardar borrador</button>
				<button class="secondary" id="sendRow">Enviar y guardar</button>
				<button class="secondary" id="toggleColumns">Mostrar columnas ocultas</button>
				<button class="secondary" id="clearTable">Borrar todo</button>
			</div>
		</header>

		<section class="table-card tab-section active" id="borradorSection">
			<div class="table-wrap">
				<table>
					<thead>
						<tr>
							<th data-column="almacen" data-secondary="true">Almacén</th>
							<th data-column="destino">Destino</th>
							<th data-column="ubicacion" data-secondary="true" data-hide="true">Ubicación</th>
							<th data-column="coordenadas" data-secondary="true" data-hide="true">Coordenadas</th>
							<th data-column="cantidadAuto" data-extra="true">Cant. Auto</th>
							<th data-column="cantidadCamion" data-extra="true">Cant. Camión</th>
							<th data-column="otras" data-extra="true">Otras</th>
							<th data-column="llantas" data-extra="true">Llantas</th>
							<th data-column="economico">Económico</th>
							<th data-column="unidad" data-hide="true">Unidad</th>
							<th data-column="operador" data-secondary="true" data-hide="true">Operador</th>
							<th data-column="acompanante" data-extra="true" data-hide="true">Acompañante</th>
							<th data-column="empezar" data-extra="true">Empezar a cargar</th>
							<th data-column="acciones" data-extra="true">Acciones</th>
						</tr>
					</thead>
					<tbody id="tableBody"></tbody>
				</table>
			</div>
			<p class="footer-note">
				Los datos se guardan automáticamente en este navegador.
			</p>
		</section>

		<section class="table-card tab-section" id="logisticaSection">
			<h2 id="logisticaTitle">Logística del día</h2>
			<p class="footer-note" id="logisticaDate">Fecha:</p>
			<div class="actions" id="logisticaActions">
				<input
					type="text"
					id="logisticaSearchDate"
					class="search-field"
					placeholder="Buscar fecha (dd/mm/aaaa)"
				/>
				<button class="secondary" id="logisticaSearchBtn">Buscar</button>
				<button class="secondary" id="printLogistica">Generar PDF</button>
				<button class="secondary" id="showLogisticaColumns">
					Mostrar columnas
				</button>
			</div>
			<p class="footer-note" id="pdfColumnsNote"></p>
			<div id="logisticaLists"></div>
		</section>

		<datalist id="almacenOpciones">
			<option value="1"></option>
			<option value="2"></option>
			<option value="3"></option>
			<option value="4"></option>
			<option value="5"></option>
			<option value="6"></option>
			<option value="7"></option>
			<option value="8"></option>
			<option value="9"></option>
			<option value="10"></option>
			<option value="11"></option>
			<option value="12"></option>
			<option value="13"></option>
			<option value="14"></option>
			<option value="15"></option>
			<option value="16"></option>
			<option value="17"></option>
			<option value="18"></option>
			<option value="19"></option>
			<option value="20"></option>
		</datalist>
		<datalist id="destinoOpciones"></datalist>
		<datalist id="economicoOpciones"></datalist>
		<datalist id="unidadOpciones"></datalist>
		<datalist id="operadorOpciones"></datalist>
		<datalist id="inicioOpciones">
			<option value="Macro"></option>
			<option value="Central"></option>
		</datalist>

		<script>
			const tableBody = document.getElementById("tableBody");
			const addRowButton = document.getElementById("addRow");
			const saveDraftButton = document.getElementById("saveDraft");
			const sendButton = document.getElementById("sendRow");
			const toggleColumnsButton = document.getElementById("toggleColumns");
			const clearButton = document.getElementById("clearTable");
			const currentDate = document.getElementById("currentDate");
			const destinoOpciones = document.getElementById("destinoOpciones");
			const economicoOpciones = document.getElementById("economicoOpciones");
			const unidadOpciones = document.getElementById("unidadOpciones");
			const operadorOpciones = document.getElementById("operadorOpciones");
			const tabBorrador = document.getElementById("tabBorrador");
			const tabLogistica = document.getElementById("tabLogistica");
			const borradorSection = document.getElementById("borradorSection");
			const logisticaSection = document.getElementById("logisticaSection");
			const logisticaTitle = document.getElementById("logisticaTitle");
			const logisticaDate = document.getElementById("logisticaDate");
			const logisticaLists = document.getElementById("logisticaLists");
			const printLogisticaButton = document.getElementById("printLogistica");
			const logisticaSearchInput = document.getElementById("logisticaSearchDate");
			const logisticaSearchButton = document.getElementById("logisticaSearchBtn");
			const showLogisticaColumnsButton = document.getElementById(
				"showLogisticaColumns"
			);

			const STORAGE_KEY = "cubicaje-hoja-libre";
			const STORAGE_LOGISTICA = "cubicaje-logistica-dia";
			const SHEETDB_ID = "mrrlieg6zoleg";
			const SHEETDB_TAB = "logistica";
			const SHEETDB_TAB_FLOTA = "flota";
			const SHEETDB_TAB_BORRADOR = "borrador";
			const SHEETDB_TAB_LOGISTICA = "hoja de logistica";

			const columns = [
				{ key: "almacen", type: "text", list: "almacenOpciones" },
				{ key: "destino", type: "text", list: "destinoOpciones" },
				{ key: "ubicacion", type: "text" },
				{ key: "coordenadas", type: "text" },
				{ key: "cantidadAuto", type: "number", extra: true },
				{ key: "cantidadCamion", type: "number", extra: true },
				{ key: "otras", type: "text", extra: true },
				{ key: "llantas", type: "number", extra: true, readOnly: true },
				{ key: "economico", type: "text", list: "economicoOpciones" },
				{ key: "unidad", type: "text" },
				{ key: "operador", type: "text" },
				{ key: "acompanante", type: "text", extra: true },
				{ key: "empezar", type: "datalist", extra: true },
			];

			const hideableKeys = new Set([
				"ubicacion",
				"coordenadas",
				"unidad",
				"operador",
				"acompanante",
			]);
			const logisticaColumnKeys = [
				"fecha",
				"almacen",
				"destino",
				"ubicacion",
				"coordenadas",
				"cantidadAuto",
				"cantidadCamion",
				"otras",
				"llantas",
				"economico",
				"unidad",
				"operador",
				"acompanante",
				"empezar",
			];

			const pdfColumnKeys = new Set([
				"almacen",
				"destino",
				"llantas",
				"economico",
				"empezar",
			]);

			let columnsHidden = true;

			const switchTab = (tab) => {
				const isLogistica = tab === "logistica";
				borradorSection.classList.toggle("active", !isLogistica);
				logisticaSection.classList.toggle("active", isLogistica);
				tabBorrador.classList.toggle("active", !isLogistica);
				tabLogistica.classList.toggle("active", isLogistica);
			};

			const setHideableVisibility = (hidden) => {
				columnsHidden = hidden;
				document.querySelectorAll("[data-hide='true']").forEach((cell) => {
					cell.classList.toggle("hidden-column", hidden);
				});
				toggleColumnsButton.textContent = hidden
					? "Mostrar columnas ocultas"
					: "Ocultar columnas ocultas";
			};


			const formatDate = () => {
				const today = new Date();
				currentDate.textContent = `Fecha: ${today.toLocaleDateString("es-MX", {
					weekday: "long",
					year: "numeric",
					month: "long",
					day: "numeric",
				})}`;
			};

			const hasRowContent = (row) =>
				columns.some((column) => String(row?.[column.key] || "").trim() !== "");

			const loadLocalData = () => {
				const saved = localStorage.getItem(STORAGE_KEY);
				if (!saved) {
					addRow();
					return;
				}
				try {
					const rows = JSON.parse(saved);
					if (!Array.isArray(rows) || rows.length === 0) {
						addRow();
						return;
					}
					rows.forEach((row) => addRow(row));
				} catch (error) {
					console.error("Error al cargar datos", error);
					addRow();
				}
			};

			const normalizeKey = (value) =>
				String(value || "")
					.normalize("NFD")
					.replace(/[\u0300-\u036f]/g, "")
					.toLowerCase()
					.replace(/[^a-z0-9]+/g, " ")
					.trim();

			const buildRowKeyMap = (row) => {
				const map = new Map();
				Object.keys(row || {}).forEach((key) => {
					const normalized = normalizeKey(key);
					if (normalized && !map.has(normalized)) {
						map.set(normalized, row[key]);
					}
				});
				return map;
			};

			const pickValue = (row, keys) => {
				if (!row) return "";
				const keyMap = buildRowKeyMap(row);
				for (const key of keys) {
					const normalized = normalizeKey(key);
					if (keyMap.has(normalized)) {
						const value = keyMap.get(normalized);
						return value !== undefined && value !== null ? String(value) : "";
					}
				}
				return "";
			};

			const mapSheetRowToData = (row) => ({
				fecha: pickValue(row, ["Fecha"]),
				almacen: pickValue(row, ["Almacén", "Almacen"]),
				destino: pickValue(row, ["Destino"]),
				ubicacion: pickValue(row, ["Ubicación", "Ubicacion"]),
				coordenadas: pickValue(row, ["Coordenadas", "Cordenadas"]),
				cantidadAuto: pickValue(row, ["Cant. Auto", "Cant Auto"]),
				cantidadCamion: pickValue(row, ["Cant. Camión", "Cant. Camion", "Cant Camion"]),
				otras: pickValue(row, ["Otras"]),
				llantas: pickValue(row, ["Llantas"]),
				economico: pickValue(row, ["Económico", "Economico"]),
				unidad: pickValue(row, ["Unidad"]),
				operador: pickValue(row, ["Operador"]),
				acompanante: pickValue(row, ["Acompañante", "Acompanante"]),
				empezar: pickValue(row, ["Empezar a cargar", "Empezar"]),
			});

			const mapDataToSheetRow = (row) => ({
				"Fecha": row.fecha || "",
				"Almacén": row.almacen || "",
				"Destino": row.destino || "",
				"Ubicación": row.ubicacion || "",
				"Coordenadas": row.coordenadas || "",
				"Cant. Auto": row.cantidadAuto || "",
				"Cant. Camión": row.cantidadCamion || "",
				"Otras": row.otras || "",
				"Llantas": row.llantas || "",
				"Económico": row.economico || "",
				"Unidad": row.unidad || "",
				"Operador": row.operador || "",
				"Acompañante": row.acompanante || "",
				"Empezar a cargar": row.empezar || "",
			});

			const mapDataToSheetRowBorrador = (row) => ({
				"Almacén": row.almacen || "",
				"Destino": row.destino || "",
				"Ubicación": row.ubicacion || "",
				"Coordenadas": row.coordenadas || "",
				"Cant. Auto": row.cantidadAuto || "",
				"Cant. Camión": row.cantidadCamion || "",
				"Otras": row.otras || "",
				"Llantas": row.llantas || "",
				"Económico": row.economico || "",
				"Unidad": row.unidad || "",
				"Operador": row.operador || "",
				"Acompañante": row.acompanante || "",
				"Empezar a cargar": row.empezar || "",
			});

			const loadBorradorFromApi = async () => {
				try {
					const response = await fetch(
						`https://sheetdb.io/api/v1/${SHEETDB_ID}?sheet=${encodeURIComponent(
							SHEETDB_TAB_BORRADOR
						)}`
					);
					if (!response.ok) throw new Error("Respuesta inválida");
					const data = await response.json();
					if (!Array.isArray(data) || data.length === 0) return [];
					return data
						.map((row) => mapSheetRowToData(row))
						.filter((row) => hasRowContent(row));
				} catch (error) {
					console.error("No se pudo cargar borrador", error);
					return [];
				}
			};

			const loadLogisticaFromApi = async () => {
				try {
					const response = await fetch(
						`https://sheetdb.io/api/v1/${SHEETDB_ID}?sheet=${encodeURIComponent(
							SHEETDB_TAB_LOGISTICA
						)}`
					);
					if (!response.ok) throw new Error("Respuesta inválida");
					const data = await response.json();
					if (!Array.isArray(data) || data.length === 0) return [];
					return data
						.map((row) => mapSheetRowToData(row))
						.filter((row) => hasRowContent(row));
				} catch (error) {
					console.error("No se pudo cargar logística", error);
					return [];
				}
			};

			const loadData = async () => {
				const apiRows = await loadBorradorFromApi();
				if (apiRows.length > 0) {
					apiRows.forEach((row) => addRow(row));
					return;
				}
				loadLocalData();
			};

			let logisticaRowsFromApi = [];

			const loadLogisticaData = async () => {
				const apiRows = await loadLogisticaFromApi();
				if (apiRows.length > 0) {
					logisticaRowsFromApi = apiRows;
					localStorage.setItem(STORAGE_LOGISTICA, JSON.stringify(apiRows));
					return;
				}
				localStorage.removeItem(STORAGE_LOGISTICA);
				logisticaRowsFromApi = [];
			};

			const saveData = () => {
				const rows = Array.from(tableBody.querySelectorAll("tr")).map(
					(row) => {
						const data = {};
						columns.forEach((column) => {
							const input = row.querySelector(`input[data-key="${column.key}"]`);
							data[column.key] = input ? input.value : "";
						});
						return data;
					}
				);
				localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
			};

			let destinoCatalogo = [];
			let destinoIndex = new Map();
			let flotaCatalogo = [];
			let economicoIndex = new Map();

			const buildDestinoIndex = (rows) => {
				destinoIndex = new Map();
				rows.forEach((row) => {
					const destino = (row.DESTINO || "").trim();
					if (destino) {
						destinoIndex.set(destino.toLowerCase(), {
							destino,
							direccion: (row.DIRECCION || "").trim(),
							coordenadas: (row.CORDENADAS || "").trim(),
						});
					}
				});
			};

			const renderDestinoOpciones = (rows) => {
				destinoOpciones.innerHTML = "";
				rows.forEach((row) => {
					const destino = (row.DESTINO || "").trim();
					if (!destino) return;
					const option = document.createElement("option");
					option.value = destino;
					destinoOpciones.appendChild(option);
				});
			};

			const buildEconomicoIndex = (rows) => {
				economicoIndex = new Map();
				rows.forEach((row) => {
					const economico = (row.economico || row.ECONOMICO || "").trim();
					if (economico) {
						economicoIndex.set(economico.toLowerCase(), {
							economico,
							unidad: (row.unidad || row.UNIDAD || "").trim(),
							operador: (row.encargado || row.ENCARGADO || "").trim(),
						});
					}
				});
			};

			const renderEconomicoOpciones = (rows) => {
				economicoOpciones.innerHTML = "";
				rows.forEach((row) => {
					const economico = (row.economico || row.ECONOMICO || "").trim();
					if (!economico) return;
					const option = document.createElement("option");
					option.value = economico;
					economicoOpciones.appendChild(option);
				});
			};

			const renderUnidadOpciones = (rows) => {
				unidadOpciones.innerHTML = "";
				const unique = new Set();
				rows.forEach((row) => {
					const unidad = (row.unidad || row.UNIDAD || "").trim();
					if (unidad) unique.add(unidad);
				});
				Array.from(unique).forEach((unidad) => {
					const option = document.createElement("option");
					option.value = unidad;
					unidadOpciones.appendChild(option);
				});
			};

			const renderOperadorOpciones = (rows) => {
				operadorOpciones.innerHTML = "";
				const unique = new Set();
				rows.forEach((row) => {
					const operador = (row.encargado || row.ENCARGADO || "").trim();
					if (operador) unique.add(operador);
				});
				Array.from(unique).forEach((operador) => {
					const option = document.createElement("option");
					option.value = operador;
					operadorOpciones.appendChild(option);
				});
			};

			const loadDestinoData = async () => {
				try {
					const response = await fetch(
						`https://sheetdb.io/api/v1/${SHEETDB_ID}?sheet=${encodeURIComponent(
							SHEETDB_TAB
						)}`
					);
					if (!response.ok) throw new Error("Respuesta inválida");
					const data = await response.json();
					if (Array.isArray(data)) {
						destinoCatalogo = data;
						buildDestinoIndex(data);
						renderDestinoOpciones(data);
					}
				} catch (error) {
					console.error("No se pudo cargar SheetDB", error);
				}
			};

			const loadFlotaData = async () => {
				try {
					const response = await fetch(
						`https://sheetdb.io/api/v1/${SHEETDB_ID}?sheet=${encodeURIComponent(
							SHEETDB_TAB_FLOTA
						)}`
					);
					if (!response.ok) throw new Error("Respuesta inválida");
					const data = await response.json();
					if (Array.isArray(data)) {
						flotaCatalogo = data;
						buildEconomicoIndex(data);
						renderEconomicoOpciones(data);
						renderUnidadOpciones(data);
						renderOperadorOpciones(data);
					}
				} catch (error) {
					console.error("No se pudo cargar flota", error);
				}
			};

			const applyDestinoAutoFill = (row, destinoValue) => {
				const record = destinoIndex.get(destinoValue.toLowerCase());
				if (!record) return;
				const ubicacionInput = row.querySelector("input[data-key='ubicacion']");
				const coordenadasInput = row.querySelector(
					"input[data-key='coordenadas']"
				);
				if (ubicacionInput) ubicacionInput.value = record.direccion;
				if (coordenadasInput) coordenadasInput.value = record.coordenadas;
				saveData();
			};

			const applyEconomicoAutoFill = (row, economicoValue) => {
				const record = economicoIndex.get(economicoValue.toLowerCase());
				if (!record) return;
				const unidadInput = row.querySelector("input[data-key='unidad']");
				const operadorInput = row.querySelector("input[data-key='operador']");
				if (unidadInput) unidadInput.value = record.unidad;
				if (operadorInput) operadorInput.value = record.operador;
				saveData();
			};

			const createInput = (column, value = "") => {
				const input = document.createElement("input");
				input.value = value;
				input.dataset.key = column.key;

				if (column.type === "number") {
					input.type = "number";
					input.min = "0";
				} else if (column.type === "datalist") {
					input.type = "text";
					input.setAttribute("list", "inicioOpciones");
				} else {
					input.type = column.type;
				}

				if (column.list) {
					input.setAttribute("list", column.list);
				}

				if (column.readOnly) {
					input.readOnly = true;
					input.tabIndex = -1;
				}

				if (column.key === "llantas") {
					input.placeholder = "0";
				}

				input.addEventListener("input", saveData);

				if (column.key === "destino") {
					input.addEventListener("change", (event) => {
						const row = event.target.closest("tr");
						if (!row) return;
						applyDestinoAutoFill(row, event.target.value || "");
					});
					input.addEventListener("blur", (event) => {
						const row = event.target.closest("tr");
						if (!row) return;
						applyDestinoAutoFill(row, event.target.value || "");
					});
				}

				if (column.key === "economico") {
					input.addEventListener("change", (event) => {
						const row = event.target.closest("tr");
						if (!row) return;
						applyEconomicoAutoFill(row, event.target.value || "");
					});
					input.addEventListener("blur", (event) => {
						const row = event.target.closest("tr");
						if (!row) return;
						applyEconomicoAutoFill(row, event.target.value || "");
					});
				}

				return input;
			};

			const sumNumbers = (value) => {
				const matches = String(value || "").match(/-?\d+(?:\.\d+)?/g);
				if (!matches) return 0;
				return matches.reduce((total, match) => {
					const numberValue = Number(match);
					return total + (Number.isFinite(numberValue) ? Math.abs(numberValue) : 0);
				}, 0);
			};

			const updateLlantasValue = (row) => {
				if (!row) return;
				const autoInput = row.querySelector("input[data-key='cantidadAuto']");
				const camionInput = row.querySelector("input[data-key='cantidadCamion']");
				const otrasInput = row.querySelector("input[data-key='otras']");
				const llantasInput = row.querySelector("input[data-key='llantas']");
				if (!llantasInput) return;
				const total =
					sumNumbers(autoInput?.value) +
					sumNumbers(camionInput?.value) +
					sumNumbers(otrasInput?.value);
				llantasInput.value = total > 0 ? String(total) : "";
			};

			const getRowDataFromRow = (row) => {
				const data = {};
				columns.forEach((column) => {
					const input = row.querySelector(`input[data-key="${column.key}"]`);
					data[column.key] = input ? input.value : "";
				});
				return data;
			};

			const unitFields = new Set([
				"economico",
				"unidad",
				"operador",
				"acompanante",
				"empezar",
			]);

			let unitGroupCounter = 0;

			const buildUnitRowData = (source) => {
				const data = { ...source };
				unitFields.forEach((key) => {
					data[key] = "";
				});
				data.llantas = "";
				return data;
			};

			const applyUnitGroup = (row, groupId) => {
				if (!row || groupId === null || groupId === undefined) return;
				row.dataset.unitGroup = String(groupId);
				row.classList.add("unit-group");
				if (groupId % 2 === 0) {
					row.classList.add("unit-group-alt");
				} else {
					row.classList.remove("unit-group-alt");
				}
			};

			const promptForUnits = (row) => {
				if (!row || row.dataset.unitsPrompted === "true") return;
				const response = window.prompt(
					"¿Cuantas unidades deseas añadir para este cliente?",
					"1"
				);
				if (response === null) return;
				const requested = Number.parseInt(String(response).trim(), 10);
				if (!Number.isFinite(requested) || requested < 1) return;
				const totalUnits = Math.min(requested, 20);
				row.dataset.unitsPrompted = "true";
				if (totalUnits === 1) return;
				unitGroupCounter += 1;
				const groupId = unitGroupCounter;
				applyUnitGroup(row, groupId);
				const sourceData = getRowDataFromRow(row);
				const unitData = buildUnitRowData(sourceData);
				let insertAfter = row;
				for (let index = 1; index < totalUnits; index += 1) {
					const newRow = addRow(unitData, {
						afterRow: insertAfter,
						groupId,
					});
					newRow.dataset.unitsPrompted = "true";
					insertAfter = newRow;
				}
			};

			const createRowElement = (rowData = {}, groupId = null) => {
				const row = document.createElement("tr");

				columns.forEach((column) => {
					const cell = document.createElement("td");
					if (hideableKeys.has(column.key)) {
						cell.dataset.hide = "true";
						if (columnsHidden) {
							cell.classList.add("hidden-column");
						}
					}
					cell.appendChild(createInput(column, rowData[column.key] || ""));
					row.appendChild(cell);
				});

				const autoInput = row.querySelector("input[data-key='cantidadAuto']");
				const camionInput = row.querySelector("input[data-key='cantidadCamion']");
				const otrasInput = row.querySelector("input[data-key='otras']");
				[autoInput, camionInput, otrasInput].forEach((input) => {
					if (!input) return;
					input.addEventListener("input", () => {
						updateLlantasValue(row);
						saveData();
					});
				});

				const llantasInput = row.querySelector("input[data-key='llantas']");
				if (llantasInput) {
					llantasInput.addEventListener("mouseenter", () => promptForUnits(row));
					llantasInput.addEventListener("focus", () => promptForUnits(row));
				}

				const actionsCell = document.createElement("td");
				const actions = document.createElement("div");
				actions.className = "row-actions";
				const deleteButton = document.createElement("button");
				deleteButton.textContent = "Eliminar";
				deleteButton.className = "danger";
				deleteButton.type = "button";
				deleteButton.addEventListener("click", () => {
					row.remove();
					if (tableBody.children.length === 0) {
						addRow();
					}
					saveData();
				});
				actions.appendChild(deleteButton);
				actionsCell.appendChild(actions);
				row.appendChild(actionsCell);

				applyUnitGroup(row, groupId);

				return row;
			};

			const addRow = (rowData = {}, options = {}) => {
				const row = createRowElement(rowData, options.groupId ?? null);
				if (options.afterRow) {
					tableBody.insertBefore(row, options.afterRow.nextSibling);
				} else {
					tableBody.appendChild(row);
				}
				updateLlantasValue(row);
				saveData();
				return row;
			};

			const getCurrentRows = () =>
				Array.from(tableBody.querySelectorAll("tr")).map((row) => {
					const data = {};
					columns.forEach((column) => {
						const input = row.querySelector(`input[data-key="${column.key}"]`);
						data[column.key] = input ? input.value : "";
					});
					return data;
				});

			const getLogisticaBodies = () =>
				Array.from(logisticaLists?.querySelectorAll("tbody") || []);

			const getLogisticaRowsFromTable = () =>
				getLogisticaBodies().flatMap((body) =>
					Array.from(body.querySelectorAll("tr")).map((row) => {
						const data = {};
						logisticaColumnKeys.forEach((key, index) => {
							const cell = row.children[index];
							if (!cell) {
								data[key] = "";
								return;
							}
							const input = cell.querySelector("textarea, input");
							data[key] = input ? input.value : "";
						});
						return data;
					})
				);

			const getLogisticaRowsForView = () => {
				if (logisticaRowsFromApi.length > 0) return logisticaRowsFromApi;
				const currentRows = getCurrentRows().filter((row) => hasRowContent(row));
				if (currentRows.length > 0) return currentRows;
				return [];
			};

			let savingBorrador = false;
			let pendingBorradorSave = false;

			const chunkRows = (rows, size) => {
				const chunks = [];
				for (let index = 0; index < rows.length; index += size) {
					chunks.push(rows.slice(index, index + size));
				}
				return chunks;
			};

			const sendRowsToSheet = async (
				sheetName,
				rows,
				rowMapper = null,
				options = {}
			) => {
				const baseUrl = `https://sheetdb.io/api/v1/${SHEETDB_ID}`;
				const { clearFirst = true } = options;
				if (clearFirst) {
					const deleteResponse = await fetch(
						`${baseUrl}/all?sheet=${encodeURIComponent(sheetName)}`,
						{ method: "DELETE" }
					);
					if (!deleteResponse.ok) {
						const details = await deleteResponse.text();
						throw new Error(
							`No se pudo limpiar la hoja (${deleteResponse.status}). ${details}`
						);
					}
				}
				if (!rows || rows.length === 0) return;
				const mapper = rowMapper || mapDataToSheetRow;
				const chunks = chunkRows(rows, 200);
				for (const chunk of chunks) {
					const payload = {
						data: chunk.map((row) => mapper(row)),
					};
					const insertResponse = await fetch(
						`${baseUrl}?sheet=${encodeURIComponent(sheetName)}`,
						{
							method: "POST",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify(payload),
						}
					);
					if (!insertResponse.ok) {
						const details = await insertResponse.text();
						throw new Error(
							`No se pudo guardar en la hoja (${insertResponse.status}). ${details}`
						);
					}
				}
			};

			const saveBorradorToApi = async () => {
				if (savingBorrador) {
					pendingBorradorSave = true;
					return;
				}
				savingBorrador = true;
				try {
					await sendRowsToSheet(SHEETDB_TAB_BORRADOR, getCurrentRows());
				} catch (error) {
					console.error("No se pudo guardar el borrador", error);
				} finally {
					savingBorrador = false;
					if (pendingBorradorSave) {
						pendingBorradorSave = false;
						saveBorradorToApi();
					}
				}
			};


			const logisticaHiddenColumns = new Set();

			const applyLogisticaColumnVisibility = () => {
				logisticaColumnKeys.forEach((key) => {
					const hidden = logisticaHiddenColumns.has(key);
					document
						.querySelectorAll(`.logistica-table .col-${key}`)
						.forEach((cell) => {
							cell.classList.toggle("hidden-column", hidden);
						});
					document
						.querySelectorAll(
							`.logistica-table thead th[data-column="${key}"]`
						)
						.forEach((header) => {
							header.classList.toggle("hidden-column", hidden);
						});
				});
			};

			const getDateLabel = (sourceDate = null) => {
				if (typeof sourceDate === "string" && sourceDate.trim() !== "") {
					return sourceDate.trim();
				}
				const dateValue = sourceDate instanceof Date ? sourceDate : new Date();
				return dateValue.toLocaleDateString("es-MX", {
					weekday: "long",
					year: "numeric",
					month: "long",
					day: "numeric",
				});
			};

			const normalizeSearchValue = (value) =>
				String(value || "")
					.toLowerCase()
					.replace(/\s+/g, "")
					.replace(/[^0-9a-z/.-]/g, "");

			const applyLogisticaSearch = (query) => {
				if (!logisticaLists) return;
				const normalized = normalizeSearchValue(query);
				const details = Array.from(
					logisticaLists.querySelectorAll("details.accordion-item")
				);
				if (!normalized) {
					details.forEach((detail) => {
						detail.style.display = "";
						detail.open = false;
					});
					return;
				}
				const matches = [];
				const others = [];
				details.forEach((detail) => {
					const raw = normalizeSearchValue(detail.dataset.fecha || "");
					const label = normalizeSearchValue(detail.dataset.fechaLabel || "");
					const isMatch = raw.includes(normalized) || label.includes(normalized);
					detail.style.display = isMatch ? "" : "none";
					detail.open = isMatch;
					(isMatch ? matches : others).push(detail);
				});
				if (matches.length > 0) {
					const fragment = document.createDocumentFragment();
					matches.forEach((detail) => fragment.appendChild(detail));
					others.forEach((detail) => fragment.appendChild(detail));
					logisticaLists.appendChild(fragment);
				}
			};

			const promptForLogisticaDate = () => {
				const fallbackDate = new Date().toLocaleDateString("es-MX");
				const response = window.prompt(
					"Fecha para esta logistica (ej: 06/02/2026):",
					fallbackDate
				);
				if (response === null) return null;
				const cleaned = String(response).trim();
				return cleaned || fallbackDate;
			};

			const renderLogistica = (rows) => {
				const dateLabel = getDateLabel();
				const numericDate = new Date().toLocaleDateString("es-MX");
				const uniqueFechas = Array.from(
					new Set(
						rows
							.map((row) => (row.fecha || "").trim())
							.filter((value) => value !== "")
					)
				);
				if (logisticaTitle) {
					const titleSuffix =
						uniqueFechas.length > 1
							? "Varias fechas"
							: uniqueFechas[0]
								? getDateLabel(uniqueFechas[0])
								: dateLabel;
					logisticaTitle.textContent = `Logística del día · ${titleSuffix}`;
				}
				logisticaDate.textContent = `Fecha: ${dateLabel}`;
				if (!logisticaLists) return;

				const groupedByDate = new Map();
				rows.forEach((row) => {
					const rowDate = (row.fecha || numericDate).trim() || numericDate;
					if (!groupedByDate.has(rowDate)) {
						groupedByDate.set(rowDate, []);
					}
					groupedByDate.get(rowDate).push(row);
				});

				const uniqueLine = (items) =>
					Array.from(new Set(items.filter((item) => item && item.trim() !== "")));

				const joinInline = (items) => items.join(" · ");

				const escapeAttr = (value) =>
					String(value)
						.replace(/&/g, "&amp;")
						.replace(/"/g, "&quot;")
						.replace(/</g, "&lt;")
						.replace(/>/g, "&gt;");

				const escapeText = (value) =>
					String(value)
						.replace(/&/g, "&amp;")
						.replace(/</g, "&lt;")
						.replace(/>/g, "&gt;");

				const renderInput = (value, listId = "") => {
					if (listId) {
						return `<input type="text" value="${escapeAttr(value)}" list="${listId}" />`;
					}
					return `<textarea>${escapeText(value)}</textarea>`;
				};

				const renderDelete = () =>
					`<button type="button" class="danger" data-logistica-delete="true">Eliminar</button>`;

				const renderCells = (cells) =>
					cells
						.map((cell, index) => {
							const columnKey = logisticaColumnKeys[index] || "";
							const shouldHide = hideableKeys.has(columnKey);
							const hiddenClass = shouldHide && columnsHidden ? " hidden-column" : "";
							const hideAttr = shouldHide ? " data-hide=\"true\"" : "";
							const printHideClass = pdfColumnKeys.has(columnKey)
								? ""
								: " print-hide";
							const input = renderInput(cell.value, cell.list || "");
							return `<td${hideAttr} class="col-${columnKey}${printHideClass}${hiddenClass}">${input}</td>`;
						})
						.join("");

				const renderActionCell = () =>
					`<td class="print-hide">${renderDelete()}</td>`;

				const renderTableHeader = () => `
					<thead>
						<tr>
							<th data-column="fecha" data-secondary="true" class="col-fecha" title="Ocultar columna">Fecha</th>
							<th data-column="almacen" data-secondary="true" class="col-almacen" title="Ocultar columna">Almacén</th>
							<th data-column="destino" class="col-destino" title="Ocultar columna">Destino</th>
							<th data-column="ubicacion" data-secondary="true" data-hide="true" class="print-hide col-ubicacion" title="Ocultar columna">Ubicación</th>
							<th data-column="coordenadas" data-secondary="true" data-hide="true" class="print-hide col-coordenadas" title="Ocultar columna">Coordenadas</th>
							<th data-column="cantidadAuto" data-extra="true" class="print-hide col-cantidadAuto" title="Ocultar columna">Cant. Auto</th>
							<th data-column="cantidadCamion" data-extra="true" class="print-hide col-cantidadCamion" title="Ocultar columna">Cant. Camión</th>
							<th data-column="otras" data-extra="true" class="print-hide col-otras" title="Ocultar columna">Otras</th>
							<th data-column="llantas" class="col-llantas" title="Ocultar columna">Llantas</th>
							<th data-column="economico" class="col-economico" title="Ocultar columna">Económico</th>
							<th data-column="unidad" data-hide="true" class="print-hide col-unidad" title="Ocultar columna">Unidad</th>
							<th data-column="operador" data-secondary="true" data-hide="true" class="print-hide col-operador" title="Ocultar columna">Operador</th>
							<th data-column="acompanante" data-extra="true" data-hide="true" class="print-hide col-acompanante" title="Ocultar columna">Acompañante</th>
							<th data-column="empezar" data-extra="true" class="col-empezar" title="Ocultar columna">Empezar a cargar</th>
							<th data-extra="true" class="print-hide">Acciones</th>
						</tr>
					</thead>
				`;

				const mergeRowsForDate = (dateRows, fallbackDate) => {
					const grouped = new Map();
					dateRows.forEach((row) => {
						const key = [row.destino, row.ubicacion, row.coordenadas]
							.map((value) => (value || "").trim().toLowerCase())
							.join("||");
						if (!grouped.has(key)) {
							grouped.set(key, {
								fecha: row.fecha || fallbackDate,
								almacen: row.almacen || "",
								destino: row.destino || "",
								ubicacion: row.ubicacion || "",
								coordenadas: row.coordenadas || "",
								cantidadAuto: row.cantidadAuto || "",
								cantidadCamion: row.cantidadCamion || "",
								otras: row.otras || "",
								acompanante: row.acompanante || "",
								empezar: row.empezar || "",
								unidades: [],
							});
						}
						const current = grouped.get(key);
						current.unidades.push({
							economico: row.economico || "",
							unidad: row.unidad || "",
							operador: row.operador || "",
						});
					});

					const mergeByUnidad = new Map();

					const addUnique = (list, value) => {
						const clean = (value || "").trim();
						if (!clean) return;
						if (!list.includes(clean)) list.push(clean);
					};

					const formatAlmacenLabel = (value) => {
						const clean = (value || "").trim();
						if (!clean) return "";
						const withoutPrefix = clean
							.replace(/^almac[eé]n\s*/i, "")
							.trim();
						if (!withoutPrefix) return "";
						return `Almacén ${withoutPrefix}`;
					};

					Array.from(grouped.values()).forEach((row) => {
					const rowEconomicos = uniqueLine(row.unidades.map((u) => u.economico));
					const rowUnidades = uniqueLine(row.unidades.map((u) => u.unidad));
					const rowOperadores = uniqueLine(row.unidades.map((u) => u.operador));
					const baseKey = [row.fecha, row.destino, row.ubicacion, row.coordenadas]
						.map((value) => (value || "").trim().toLowerCase())
						.join("||");

					if (rowUnidades.length === 0 && rowEconomicos.length === 0) {
						const key = `destino:${baseKey}`;
						if (!mergeByUnidad.has(key)) {
							mergeByUnidad.set(key, {
								fecha: row.fecha || "",
								almacenes: [],
								destinos: [],
								ubicaciones: [],
								coordenadas: [],
								cantidadAuto: [],
								cantidadCamion: [],
								otras: [],
								economicos: [],
								unidades: [],
								operadores: [],
								acompanantes: [],
								empezar: [],
							});
						}
						const entry = mergeByUnidad.get(key);
						if (!entry.fecha && row.fecha) entry.fecha = row.fecha;
						addUnique(entry.almacenes, formatAlmacenLabel(row.almacen));
						addUnique(entry.destinos, row.destino);
						addUnique(entry.ubicaciones, row.ubicacion);
						addUnique(entry.coordenadas, row.coordenadas);
						addUnique(entry.cantidadAuto, row.cantidadAuto);
						addUnique(entry.cantidadCamion, row.cantidadCamion);
						addUnique(entry.otras, row.otras);
						addUnique(entry.acompanantes, row.acompanante);
						addUnique(entry.empezar, row.empezar);
						return;
					}

					const unitKey = [rowEconomicos.join("|"), rowUnidades.join("|"), rowOperadores.join("|")]
						.map((value) => (value || "").trim().toLowerCase())
						.join("||");
					const key = `unidad:${unitKey || baseKey}`;
					if (!mergeByUnidad.has(key)) {
						mergeByUnidad.set(key, {
							fecha: row.fecha || "",
							almacenes: [],
							destinos: [],
							ubicaciones: [],
							coordenadas: [],
							cantidadAuto: [],
							cantidadCamion: [],
							otras: [],
							economicos: [],
							unidades: [],
							operadores: [],
							acompanantes: [],
								empezar: [],
							});
					}

					const entry = mergeByUnidad.get(key);
					if (!entry.fecha && row.fecha) entry.fecha = row.fecha;
					addUnique(entry.almacenes, formatAlmacenLabel(row.almacen));
					addUnique(entry.destinos, row.destino);
					addUnique(entry.ubicaciones, row.ubicacion);
					addUnique(entry.coordenadas, row.coordenadas);
					addUnique(entry.cantidadAuto, row.cantidadAuto);
					addUnique(entry.cantidadCamion, row.cantidadCamion);
					addUnique(entry.otras, row.otras);
					rowEconomicos.forEach((value) => addUnique(entry.economicos, value));
					rowUnidades.forEach((value) => addUnique(entry.unidades, value));
					rowOperadores.forEach((value) => addUnique(entry.operadores, value));
					addUnique(entry.acompanantes, row.acompanante);
					addUnique(entry.empezar, row.empezar);
					});

					const sumList = (list) =>
						(list || []).reduce((total, value) => total + sumNumbers(value), 0);

					const mergedRows = Array.from(mergeByUnidad.values());
					const bodyRows = mergedRows
						.map((row) => {
							const llantasTotal =
								sumList(row.cantidadAuto) +
								sumList(row.cantidadCamion) +
								sumList(row.otras);
							const cells = [
								{ value: row.fecha || "" },
								{ value: joinInline(row.almacenes) },
								{ value: joinInline(row.destinos) },
								{ value: joinInline(row.ubicaciones) },
								{ value: joinInline(row.coordenadas) },
								{ value: joinInline(row.cantidadAuto) },
								{ value: joinInline(row.cantidadCamion) },
								{ value: joinInline(row.otras) },
								{ value: llantasTotal > 0 ? String(llantasTotal) : "" },
								{ value: joinInline(row.economicos), list: "economicoOpciones" },
								{ value: joinInline(row.unidades), list: "unidadOpciones" },
								{ value: joinInline(row.operadores), list: "operadorOpciones" },
								{ value: joinInline(row.acompanantes) },
								{ value: joinInline(row.empezar) },
							];
							return `<tr>${renderCells(cells)}${renderActionCell()}</tr>`;
						})
						.join("");

					return bodyRows;
				};

				if (groupedByDate.size === 0) {
					const emptyCells = Array.from(
						{ length: logisticaColumnKeys.length },
						() => ({ value: "" })
					);
					const emptyBody = `<tbody><tr>${renderCells(emptyCells)}${renderActionCell()}</tr></tbody>`;
					logisticaLists.innerHTML = `
						<details class="accordion-item">
							<summary><div class="accordion-summary">Logística</div></summary>
							<div class="accordion-content">
								<div class="table-wrap">
									<table class="logistica-table">${renderTableHeader()}${emptyBody}</table>
								</div>
							</div>
						</details>
					`;
					applyLogisticaColumnVisibility();
					autoResizeLogisticaTextareas();
					return;
				}

				const detailsBlocks = Array.from(groupedByDate.entries())
					.map(([fecha, dateRows]) => {
						const bodyRows = mergeRowsForDate(dateRows, fecha || numericDate);
						return `
							<details class="accordion-item" data-fecha="${escapeAttr(fecha)}" data-fecha-label="${escapeAttr(getDateLabel(fecha))}">
								<summary>
									<div class="accordion-summary">Logística · ${getDateLabel(fecha)}</div>
								</summary>
								<div class="accordion-content">
									<div class="table-wrap">
										<table class="logistica-table">${renderTableHeader()}<tbody>${bodyRows}</tbody></table>
									</div>
								</div>
							</details>
						`;
					})
					.join("");

				logisticaLists.innerHTML = detailsBlocks;
				applyLogisticaColumnVisibility();
				autoResizeLogisticaTextareas();
				applyLogisticaSearch(logisticaSearchInput?.value || "");
			};

			const autoResizeLogisticaTextareas = () => {
				getLogisticaBodies().forEach((body) => {
					body.querySelectorAll("textarea").forEach((textarea) => {
						textarea.style.height = "auto";
						textarea.style.height = `${textarea.scrollHeight}px`;
					});
				});
			};

			const truncateWords = (text, maxWords) => {
				const words = String(text || "")
					.trim()
					.split(/\s+/)
					.filter(Boolean);
				return words.slice(0, maxWords).join(" ");
			};

			const applyDestinoPrintTruncate = () => {
				getLogisticaBodies().forEach((body) => {
					const destinoCells = body.querySelectorAll("tr td:nth-child(3)");
					destinoCells.forEach((cell) => {
						const input = cell.querySelector("textarea, input");
						if (!input) return;
						const current = input.value || input.textContent || "";
						if (!input.dataset.fullText) {
							input.dataset.fullText = current;
						}
						const truncated = truncateWords(input.dataset.fullText, 3);
						if ("value" in input) {
							input.value = truncated;
						} else {
							input.textContent = truncated;
						}
					});
				});
			};

			const restoreDestinoAfterPrint = () => {
				getLogisticaBodies().forEach((body) => {
					const destinoCells = body.querySelectorAll("tr td:nth-child(3)");
					destinoCells.forEach((cell) => {
						const input = cell.querySelector("textarea, input");
						if (!input || !input.dataset.fullText) return;
						const original = input.dataset.fullText;
						if ("value" in input) {
							input.value = original;
						} else {
							input.textContent = original;
						}
						delete input.dataset.fullText;
					});
				});
				autoResizeLogisticaTextareas();
			};

			addRowButton.addEventListener("click", () => addRow());
			saveDraftButton.addEventListener("click", async () => {
				try {
					await saveBorradorToApi();
					alert("Borrador guardado en la base.");
				} catch (error) {
					console.error("No se pudo guardar el borrador", error);
					alert("No se pudo guardar el borrador.");
				}
			});

			tabBorrador.addEventListener("click", () => switchTab("borrador"));
			tabLogistica.addEventListener("click", () => {
				renderLogistica(getLogisticaRowsForView());
				switchTab("logistica");
			});

			showLogisticaColumnsButton?.addEventListener("click", () => {
				logisticaHiddenColumns.clear();
				applyLogisticaColumnVisibility();
			});

			const handleLogisticaSearch = () => {
				applyLogisticaSearch(logisticaSearchInput?.value || "");
			};

			logisticaSearchButton?.addEventListener("click", handleLogisticaSearch);
			logisticaSearchInput?.addEventListener("input", handleLogisticaSearch);

			printLogisticaButton.addEventListener("click", () => {
				const tableRows = getLogisticaRowsFromTable().filter((row) =>
					hasRowContent(row)
				);
				renderLogistica(tableRows.length > 0 ? tableRows : getLogisticaRowsForView());
				switchTab("logistica");
				setTimeout(() => {
					applyDestinoPrintTruncate();
					window.print();
				}, 100);
			});

			window.addEventListener("beforeprint", () => {
				applyDestinoPrintTruncate();
			});

			window.addEventListener("afterprint", () => {
				restoreDestinoAfterPrint();
			});

			logisticaLists?.addEventListener("click", (event) => {
				const target = event.target;
				if (!(target instanceof HTMLElement)) return;
				const header = target.closest("th[data-column]");
				if (header) {
					const key = header.dataset.column;
					if (!key) return;
					if (logisticaHiddenColumns.has(key)) {
						logisticaHiddenColumns.delete(key);
					} else {
						logisticaHiddenColumns.add(key);
					}
					applyLogisticaColumnVisibility();
					renderLogistica(getLogisticaRowsForView());
					return;
				}
				if (target.matches("[data-logistica-delete='true']")) {
					const row = target.closest("tr");
					if (row) row.remove();
				}
			});

			logisticaLists?.addEventListener("input", (event) => {
				const target = event.target;
				if (target instanceof HTMLTextAreaElement) {
					target.style.height = "auto";
					target.style.height = `${target.scrollHeight}px`;
				}
			});

			toggleColumnsButton.addEventListener("click", () => {
				setHideableVisibility(!columnsHidden);
			});


			sendButton.addEventListener("click", async () => {
				const dateLabel = promptForLogisticaDate();
				if (!dateLabel) return;
				const rows = getCurrentRows().map((row) => ({
					...row,
					fecha: dateLabel,
				}));
				try {
					await sendRowsToSheet(SHEETDB_TAB_LOGISTICA, rows, null, {
						clearFirst: false,
					});
					await sendRowsToSheet(SHEETDB_TAB_BORRADOR, [], mapDataToSheetRowBorrador);
					await loadLogisticaData();
				} catch (error) {
					console.error("No se pudo guardar logística", error);
					alert(
						`No se pudo guardar en la base. ${error?.message || "Intenta de nuevo."}`
					);
					return;
				}
				localStorage.setItem(STORAGE_LOGISTICA, JSON.stringify(rows));
				renderLogistica(getLogisticaRowsForView());
				switchTab("logistica");
				tableBody.innerHTML = "";
				addRow();
				localStorage.removeItem(STORAGE_KEY);
			});

			clearButton.addEventListener("click", () => {
				if (!confirm("¿Seguro que quieres borrar todas las filas?")) {
					return;
				}
				tableBody.innerHTML = "";
				addRow();
				saveData();
			});

			formatDate();
			setHideableVisibility(true);
			loadDestinoData();
			loadFlotaData();
			loadData().catch((error) => console.error("Error al cargar", error));
			loadLogisticaData().catch((error) =>
				console.error("Error al cargar logística", error)
			);
		</script>
	</body>
</html>
