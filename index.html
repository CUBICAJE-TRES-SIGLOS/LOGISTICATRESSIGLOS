<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Borrador - Hoja libre de carga</title>
		<style>
			:root {
				color-scheme: light;
				--bg: #f7f9fc;
				--paper-line: rgba(37, 99, 235, 0.12);
				--paper-shadow: rgba(15, 23, 42, 0.04);
				--card: #ffffff;
				--text: #0f172a;
				--muted: #64748b;
				--border: #e2e8f0;
				--accent: #2563eb;
				--accent-2: #0ea5e9;
			}

			* {
			body.logistica-active header .actions {
				display: none;
			}
				box-sizing: border-box;
				margin: 0;
				padding: 0;
				font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
			}

			body {
				background-color: var(--bg);
				background-image: linear-gradient(
						0deg,
						transparent 31px,
						var(--paper-line) 31px,
						var(--paper-line) 32px,
						transparent 32px
					),
					linear-gradient(180deg, var(--paper-shadow), transparent 120px);
				background-size: 100% 32px, 100% 100%;
				background-attachment: fixed;
				color: var(--text);
				padding: 32px 24px 48px;
			}

			header {
				display: flex;
				flex-direction: column;
				gap: 12px;
				margin-bottom: 24px;
			}

			header h1 {
				font-size: 28px;
				font-weight: 700;
			}

			.subline {
				display: flex;
				flex-wrap: wrap;
				align-items: center;
				gap: 16px;
				color: var(--muted);
				font-size: 14px;
			}

			.badge {
				background: rgba(37, 99, 235, 0.1);
				color: var(--accent);
				padding: 6px 12px;
				border-radius: 999px;
				font-weight: 600;
			}

			.actions {
				display: flex;
				flex-wrap: wrap;
				gap: 12px;
				margin-top: 8px;
			}

			body.logistica-active #borradorColumnPanel {
				display: none !important;
			}

			.column-panel {
				display: none;
				margin-top: 10px;
				padding: 10px 12px;
				border: 1px dashed var(--border);
				border-radius: 12px;
				background: #f8fafc;
				gap: 8px;
			}

			.column-panel.open {
				display: grid;
			}

			.column-panel-title {
				font-size: 12px;
				font-weight: 700;
				color: var(--muted);
				text-transform: uppercase;
				letter-spacing: 0.04em;
			}

			.column-panel-summary {
				font-size: 12px;
				color: var(--muted);
			}

			.column-toggle-list {
				display: flex;
				flex-wrap: wrap;
				gap: 10px 16px;
			}

			.column-toggle {
				display: inline-flex;
				align-items: center;
				gap: 6px;
				font-size: 13px;
				color: var(--text);
			}

			.column-toggle input {
				accent-color: var(--accent);
			}

			.actions .search-field {
				min-width: 200px;
				max-width: 240px;
			}

			.tabs {
				display: inline-flex;
				gap: 8px;
				background: #fff;
				border: 1px solid var(--border);
				border-radius: 999px;
				padding: 4px;
				width: fit-content;
			}

			.tab-button {
				border: none;
				background: transparent;
				padding: 8px 16px;
				border-radius: 999px;
				font-weight: 600;
				color: var(--muted);
				cursor: pointer;
			}

			.tab-button.active {
				background: rgba(37, 99, 235, 0.12);
				color: var(--accent);
			}

			button {
				border: none;
				border-radius: 10px;
				padding: 10px 16px;
				font-size: 14px;
				font-weight: 600;
				cursor: pointer;
				transition: transform 0.1s ease, box-shadow 0.2s ease;
			}

			button.primary {
				background: var(--accent);
				color: #fff;
				box-shadow: 0 8px 16px rgba(37, 99, 235, 0.2);
			}

			button.secondary {
				background: #fff;
				color: var(--accent);
				border: 1px solid var(--border);
			}

			button:active {
				transform: scale(0.98);
			}

			.table-card {
				background: var(--card);
				border: 1px solid var(--border);
				border-radius: 16px;
				padding: 16px;
				box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
				overflow: hidden;
			}

			.table-wrap {
				overflow-x: auto;
				padding-bottom: 8px;
			}

			table {
				width: 100%;
				border-collapse: collapse;
				min-width: 1200px;
			}

			.logistica-table {
				table-layout: fixed;
				min-width: 1600px;
			}

			thead th {
				position: sticky;
				top: 0;
				background: #f8fafc;
				color: var(--muted);
				font-size: 12px;
				text-transform: uppercase;
				letter-spacing: 0.04em;
				padding: 12px 10px;
				border-bottom: 1px solid var(--border);
			}

			tbody td {
				border-bottom: 1px solid var(--border);
				padding: 10px;
				vertical-align: top;
			}

			tbody tr:hover {
				background: #f1f5f9;
			}

			tbody tr.unit-group {
				background: rgba(251, 191, 36, 0.18);
				box-shadow: inset 6px 0 0 rgba(245, 158, 11, 0.95);
			}

			tbody tr.unit-group-alt {
				background: rgba(74, 222, 128, 0.18);
				box-shadow: inset 6px 0 0 rgba(34, 197, 94, 0.95);
			}

			tbody tr.row-alt {
				background: rgba(14, 165, 233, 0.08);
			}

			tbody tr.row-alt-2 {
				background: rgba(251, 191, 36, 0.14);
			}

			input[type="text"],
			input[type="number"],
			input[type="datetime-local"],
			select {
				width: 100%;
				border: 1px solid var(--border);
				border-radius: 8px;
				padding: 8px 10px;
				font-size: 14px;
				background: #fff;
				color: var(--text);
			}

			input[readonly] {
				background: #f8fafc;
				font-weight: 600;
			}

			input[type="number"] {
				text-align: center;
			}

			.wide-input {
				min-width: 140px;
			}

			.row-actions {
				display: flex;
				gap: 8px;
			}

			.row-actions button {
				padding: 6px 10px;
				font-size: 12px;
				border-radius: 8px;
			}

			.row-actions .danger {
				background: #fee2e2;
				color: #b91c1c;
			}

			.hidden-column {
				display: none;
			}

			.print-only {
				display: none;
			}

			.footer-note {
				margin-top: 12px;
				font-size: 12px;
				color: var(--muted);
			}

			.tab-section {
				display: none;
			}

			.tab-section.active {
				display: block;
			}

			.logistica-table th,
			.logistica-table td {
				white-space: nowrap;
				vertical-align: top;
				padding: 10px 12px;
			}

			.accordion-item {
				border: 1px solid var(--border);
				border-radius: 12px;
				background: #fff;
				padding: 10px 14px;
				box-shadow: 0 8px 20px rgba(15, 23, 42, 0.05);
			}

			.accordion-item summary {
				cursor: pointer;
				font-weight: 700;
				list-style: none;
				display: flex;
				align-items: center;
				justify-content: space-between;
				gap: 12px;
			}

			.accordion-item summary::after {
				content: "v";
				font-weight: 700;
				color: var(--muted);
				transition: transform 0.2s ease;
			}

			.accordion-item[open] summary::after {
				transform: rotate(180deg);
			}

			.accordion-item summary::-webkit-details-marker {
				display: none;
			}

			.accordion-summary {
				display: flex;
				flex-wrap: wrap;
				gap: 8px;
				color: var(--text);
				font-size: 14px;
			}

			.accordion-chip {
				background: #f1f5f9;
				border-radius: 999px;
				padding: 4px 10px;
				font-size: 12px;
				color: var(--muted);
			}

			.accordion-content {
				margin-top: 10px;
				display: grid;
				gap: 6px;
				position: relative;
				padding-top: 46px;
				overflow: visible;
			}

			.conboy-fab {
				position: absolute;
				right: -6px;
				top: 8px;
				border: none;
				border-radius: 12px 0 0 12px;
				padding: 8px 14px;
				font-size: 12px;
				font-weight: 700;
				letter-spacing: 0.04em;
				text-transform: uppercase;
				background: linear-gradient(135deg, #e0f2fe, #bae6fd);
				color: #0c4a6e;
				box-shadow: 0 10px 24px rgba(14, 116, 144, 0.25);
				cursor: pointer;
				transition: transform 0.15s ease, box-shadow 0.2s ease;
			}

			.conboy-fab:hover {
				transform: translateX(-2px);
				box-shadow: 0 14px 28px rgba(14, 116, 144, 0.3);
			}

			.conboy-modal {
				position: fixed;
				inset: 0;
				background: rgba(15, 23, 42, 0.45);
				display: none;
				align-items: center;
				justify-content: center;
				padding: 24px;
				z-index: 2000;
			}

			.conboy-modal.is-open {
				display: flex !important;
			}

			.conboy-container {
				width: min(960px, 92vw);
				max-height: 90vh;
				overflow: hidden;
				background: #ffffff;
				border-radius: 18px;
				box-shadow: 0 24px 60px rgba(15, 23, 42, 0.25);
				display: flex;
				flex-direction: column;
			}

			.conboy-header {
				display: flex;
				align-items: center;
				justify-content: space-between;
				gap: 12px;
				padding: 16px 20px;
				border-bottom: 1px solid var(--border);
			}

			.conboy-header h3 {
				font-size: 18px;
				font-weight: 700;
				margin: 0;
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.conboy-date-label {
				font-size: 12px;
				font-weight: 600;
				color: var(--muted);
			}

			.conboy-close {
				border: none;
				background: #f1f5f9;
				color: #0f172a;
				width: 34px;
				height: 34px;
				border-radius: 999px;
				font-size: 16px;
				cursor: pointer;
			}

			.conboy-content {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
				gap: 16px;
				padding: 18px 20px 0;
				overflow: auto;
			}

			.conboy-section {
				background: #f8fafc;
				border: 1px solid var(--border);
				border-radius: 14px;
				padding: 12px 14px;
				min-height: 220px;
			}

			.conboy-section h4 {
				font-size: 13px;
				text-transform: uppercase;
				letter-spacing: 0.06em;
				color: var(--muted);
				margin-bottom: 10px;
			}

			.conboy-units-list,
			.conboy-groups-container {
				min-height: 160px;
				border: 1px dashed var(--border);
				border-radius: 12px;
				padding: 10px;
				background: #ffffff;
				color: var(--muted);
				font-size: 13px;
			}

			.conboy-unit {
				width: 100%;
				display: flex;
				flex-direction: column;
				align-items: flex-start;
				gap: 4px;
				border: 1px solid var(--border);
				border-radius: 10px;
				padding: 8px 10px;
				background: #f8fafc;
				font-size: 13px;
				color: #0f172a;
				cursor: pointer;
				margin-bottom: 8px;
			}

			.conboy-unit-meta {
				font-size: 11px;
				color: var(--muted);
			}

			.conboy-group {
				border: 1px solid var(--border);
				border-radius: 12px;
				padding: 10px;
				margin-bottom: 10px;
				background: #f1f5f9;
			}

			.conboy-group-note {
				width: 100%;
				min-height: 60px;
				border: 1px solid var(--border);
				border-radius: 10px;
				padding: 8px 10px;
				font-size: 12px;
				background: #ffffff;
				color: var(--text);
				resize: vertical;
				margin-top: 8px;
			}

			.conboy-group.active {
				border-color: #0ea5e9;
				box-shadow: 0 8px 18px rgba(14, 165, 233, 0.2);
			}

			.conboy-group-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				gap: 8px;
				font-weight: 700;
				font-size: 13px;
				margin-bottom: 8px;
			}

			.conboy-chip {
				display: inline-flex;
				align-items: center;
				gap: 6px;
				background: #ffffff;
				border: 1px solid var(--border);
				border-radius: 999px;
				padding: 4px 10px;
				font-size: 12px;
				margin: 0 6px 6px 0;
			}

			.conboy-chip button {
				border: none;
				background: transparent;
				color: #dc2626;
				font-weight: 700;
				cursor: pointer;
			}

			.conboy-footer {
				display: flex;
				justify-content: flex-end;
				gap: 12px;
				padding: 16px 20px 20px;
			}

			.conboy-print-summary {
				display: none;
				margin-top: 8px;
				border-top: 2px solid var(--border);
				padding-top: 6px;
			}

			.conboy-print-heading {
				font-size: 14px;
				font-weight: 800;
				letter-spacing: 0.04em;
				text-transform: uppercase;
				margin-bottom: 4px;
			}

			.conboy-print-date {
				margin-bottom: 4px;
			}

			.conboy-print-date-title {
				font-size: 12px;
				font-weight: 700;
				color: var(--muted);
				margin-bottom: 6px;
			}

			.conboy-print-group {
				display: grid;
				grid-template-columns: 1fr 2fr;
				gap: 4px;
				padding: 3px 0;
				border-bottom: 1px dashed var(--border);
			}

			.conboy-print-title {
				font-weight: 700;
				font-size: 12px;
			}

			.conboy-print-economicos {
				font-size: 12px;
				line-height: 1.1;
			}

			.conboy-print-note {
				font-size: 11px;
				color: var(--muted);
				margin-top: 1px;
				line-height: 1.1;
			}

			@media (max-width: 900px) {
				.accordion-content {
					padding-top: 56px;
				}
				.conboy-fab {
					right: 12px;
					border-radius: 999px;
				}
			}

			.accordion-empty {
				border: 1px dashed var(--border);
				border-radius: 12px;
				padding: 16px;
				color: var(--muted);
				text-align: center;
			}

			.logistica-table thead th[data-column] {
				cursor: pointer;
			}

			.logistica-table .col-destino {
				max-width: 220px;
				width: 220px;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			.logistica-table .col-almacen,
			.logistica-table .col-cantidadAuto {
				max-width: 60px;
				width: 60px;
			}

			.logistica-table .col-otras {
				max-width: 70px;
				width: 70px;
			}

			.logistica-table .col-cantidadCamion,
			.logistica-table .col-otras,
			.logistica-table .col-economico,
			.logistica-table .col-acompanante {
				max-width: 90px;
				width: 90px;
			}

			.logistica-table .col-ordenCarga {
				max-width: 110px;
				width: 110px;
			}

			.logistica-table .col-fecha {
				max-width: 70px;
				width: 70px;
				white-space: nowrap;
			}

			.logistica-table input[type="text"] {
				min-width: 0;
				width: 100%;
				font-size: 13px;
				padding: 6px 8px;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}

			.logistica-table textarea {
				width: 100%;
				min-height: 32px;
				border: 1px solid var(--border);
				border-radius: 8px;
				padding: 6px 8px;
				font-size: 13px;
				background: #fff;
				color: var(--text);
				resize: none;
				overflow: hidden;
			}

			.logistica-table .stacked-fields {
				display: grid;
				gap: 6px;
			}

			.logistica-table .col-destino .stacked-field,
			.logistica-table .col-destino input,
			.logistica-table .col-destino textarea {
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			.logistica-table .col-destino .stacked-field-row {
				display: grid;
				grid-template-columns: 28px 1fr;
				align-items: center;
				gap: 6px;
			}

			.logistica-table .col-destino .stacked-field-row::before {
				content: attr(data-index) ".-";
				font-size: 12px;
				font-weight: 600;
				color: var(--muted);
			}

			.logistica-table .col-destino .destino-compact {
				display: grid;
				gap: 6px;
			}

			.logistica-table .col-destino .destino-toggle {
				display: block;
				width: 100%;
				border: 1px dashed var(--border);
				background: #f8fafc;
				color: var(--text);
				padding: 6px 8px;
				border-radius: 8px;
				font-size: 13px;
				font-weight: 600;
				text-align: left;
				cursor: pointer;
			}

			.logistica-table .col-destino .destino-details {
				display: none;
			}

			.logistica-table .col-destino .destino-compact.is-open .destino-details {
				display: grid;
			}

			.logistica-table .stacked-field {
				min-height: 28px;
			}

			.logistica-table input[type="text"],
			.logistica-table input[type="number"] {
				padding: 6px 8px;
			}

			.logistica-table .col-ordenCarga input[type="text"] {
				min-width: 0;
				width: 100%;
			}

			.logistica-comment-row td {
				padding: 10px 12px;
				background: #f8fafc;
				border-top: 2px dashed var(--border);
				border-bottom: 1px solid var(--border);
			}

			.logistica-comment-label {
				font-size: 12px;
				font-weight: 700;
				color: var(--muted);
				text-transform: uppercase;
				letter-spacing: 0.05em;
				margin-bottom: 6px;
			}

			.logistica-comment-row textarea {
				min-height: 40px;
				resize: vertical;
			}

			@media print {
				@page {
					size: A4 portrait;
					margin: 6mm;
				}

				.column-panel {
					display: none !important;
				}

				.logistica-table .col-destino .destino-toggle {
					display: none !important;
				}

				.logistica-table .col-destino .destino-details {
					display: grid !important;
				}

				body {
					background: #fff;
					padding: 0;
				}

				header,
				#borradorSection,
				#logisticaActions,
				.footer-note {
					display: none !important;
				}

				#logisticaSection {
					display: block !important;
				}

				.conboy-modal,
				.conboy-fab {
					display: none !important;
				}

				#logisticaAccordion {
					display: block !important;
				}

				#logisticaAccordion > summary {
					display: none !important;
				}

				#logisticaAccordion > .accordion-content {
					display: block !important;
				}

				.table-card {
					box-shadow: none;
					border: none;
				}

				.table-wrap {
					overflow: visible;
				}

				.logistica-table {
					width: 100% !important;
					min-width: 100% !important;
					font-size: 13.5px;
					table-layout: auto;
				}

				.logistica-table thead th {
					font-size: 12px;
					padding: 0;
					line-height: 1;
				}

				.logistica-table th,
				.logistica-table td {
					padding: 0;
					line-height: 1;
					white-space: normal;
					word-break: break-word;
					overflow-wrap: anywhere;
					border-bottom: 1px solid #94a3b8;
				}

				.logistica-table thead th {
					border-bottom: 2px solid #475569;
				}

				.logistica-table td + td,
				.logistica-table th + th {
					border-left: 1px solid #cbd5f5;
				}

				.logistica-table tbody tr:nth-child(even) {
					background: #f8fafc;
				}

				.logistica-table .col-fecha {
					width: 60px;
					max-width: 60px;
					white-space: nowrap;
				}

				.logistica-table .col-almacen {
					width: 52px;
					max-width: 52px;
				}

				.logistica-table .col-cantidadAuto,
				.logistica-table .col-cantidadCamion,
				.logistica-table .col-otras {
					width: 44px;
					max-width: 44px;
				}

				.logistica-table .col-economico,
				.logistica-table .col-acompanante {
					width: 70px;
					max-width: 70px;
				}

				.logistica-table .col-llantas {
					width: 60px;
					max-width: 60px;
				}

				.logistica-table .col-destino {
					width: 140px;
					max-width: 140px;
				}

				.logistica-table .col-ordenCarga,
				.logistica-table .col-empezar {
					width: 60px;
					max-width: 60px;
				}

				.logistica-table .col-economico input {
					display: none;
				}

				.print-only {
					display: block;
					white-space: normal;
					word-break: break-word;
				}

				.conboy-print-summary {
					display: block;
					page-break-inside: avoid;
				}

				.logistica-table .print-hide {
					display: none !important;
				}

				.logistica-table .col-fecha {
					display: none !important;
				}

				.logistica-table input {
					border: none;
					padding: 0;
					margin: 0;
					box-shadow: none;
					background: transparent;
					font-size: 13.5px;
					line-height: 1;
					height: auto !important;
					width: 100%;
				}

				.logistica-table textarea {
					border: none;
					padding: 0;
					margin: 0;
					box-shadow: none;
					background: transparent;
					font-size: 13.5px;
					line-height: 1;
					height: auto !important;
					width: 100%;
					min-height: 0;
					resize: none;
					overflow: visible;
				}

				.logistica-table .stacked-fields {
					display: grid;
					gap: 2px;
				}

				.logistica-table .stacked-field {
					display: block;
					padding: 0 2px;
				}

				.logistica-comment-label {
					display: none;
				}

				.logistica-table .col-almacen .stacked-field {
					text-align: center;
					min-height: 12px;
				}

				.hidden-column {
					display: none !important;
				}

				.print-hide {
					display: none !important;
				}
			}
		</style>
	</head>
	<body>
		<header>
			<h1>Borrador - Hoja libre de carga</h1>
			<div class="subline">
				<span class="badge" id="currentDate">Fecha:</span>
				<span>Todos los campos se pueden editar.</span>
			</div>
			<div class="tabs">
				<button class="tab-button active" id="tabBorrador">Borrador</button>
				<button class="tab-button" id="tabLogistica">Log√≠stica del d√≠a</button>
			</div>
			<div class="actions">
				<button class="primary" id="addRow">Agregar fila</button>
				<button class="secondary" id="saveDraft">Guardar borrador</button>
				<button class="secondary" id="sendRow">Enviar y guardar</button>
				<button class="secondary" id="toggleColumns">Mostrar columnas ocultas</button>
				<button class="secondary" id="clearTable">Borrar todo</button>
			</div>
			<div class="column-panel" id="borradorColumnPanel" aria-hidden="true">
				<div class="column-panel-title">Columnas ocultas</div>
				<div class="column-panel-summary" id="borradorColumnSummary"></div>
				<div class="column-toggle-list" id="borradorColumnToggles"></div>
			</div>
		</header>

		<section class="table-card tab-section active" id="borradorSection">
			<div class="table-wrap">
				<table>
					<thead>
						<tr>
							<th data-column="almacen" data-secondary="true">Almac√©n</th>
							<th data-column="destino">Destino</th>
							<th data-column="ubicacion" data-secondary="true" data-hide="true">Ubicaci√≥n</th>
							<th data-column="coordenadas" data-secondary="true" data-hide="true">Coordenadas</th>
							<th data-column="cantidadAuto" data-extra="true">Cant. Auto</th>
							<th data-column="cantidadCamion" data-extra="true">Cant. Cami√≥n</th>
							<th data-column="otras" data-extra="true">Otras</th>
							<th data-column="llantas" data-extra="true" data-hide="true">Llantas</th>
							<th data-column="economico">Econ√≥mico</th>
							<th data-column="unidad" data-hide="true">Unidad</th>
							<th data-column="operador" data-secondary="true" data-hide="true">Operador</th>
							<th data-column="acompanante" data-extra="true" data-hide="true">Acompa√±ante</th>
							<th data-column="empezar" data-extra="true">Orden de la carga</th>
							<th data-column="acciones" data-extra="true">Empezar a cargar</th>
						</tr>
					</thead>
					<tbody id="tableBody"></tbody>
				</table>
			</div>
			<p class="footer-note">
				Los datos se guardan autom√°ticamente en este navegador.
			</p>
		</section>

		<section class="table-card tab-section" id="logisticaSection">
			<h2 id="logisticaTitle">Log√≠stica del d√≠a</h2>
			<p class="footer-note" id="logisticaDate">Fecha:</p>
			<div class="actions" id="logisticaActions">
				<input
					type="text"
					id="logisticaSearchDate"
					class="search-field"
					placeholder="Buscar fecha (dd/mm/aaaa)"
				/>
				<button class="secondary" id="logisticaSearchBtn">Buscar</button>
				<button class="secondary" id="logisticaSaveChanges">
					Guardar cambios
				</button>
				<button class="secondary" id="printLogistica">Generar PDF</button>
				<button class="secondary" id="showLogisticaColumns">
					Mostrar columnas
				</button>
			</div>
			<div class="column-panel" id="logisticaColumnPanel" aria-hidden="true">
				<div class="column-panel-title">Columnas visibles</div>
				<div class="column-panel-summary" id="logisticaColumnSummary"></div>
				<div class="column-toggle-list" id="logisticaColumnToggles"></div>
			</div>
			<p class="footer-note" id="pdfColumnsNote"></p>
			<div id="logisticaLists"></div>
			<div id="conboyPrintSummary" class="conboy-print-summary print-only" aria-hidden="true"></div>
		</section>

		<datalist id="almacenOpciones">
			<option value="1"></option>
			<option value="2"></option>
			<option value="3"></option>
			<option value="4"></option>
			<option value="5"></option>
			<option value="6"></option>
			<option value="7"></option>
			<option value="8"></option>
			<option value="9"></option>
			<option value="10"></option>
			<option value="11"></option>
			<option value="12"></option>
			<option value="13"></option>
			<option value="14"></option>
			<option value="15"></option>
			<option value="16"></option>
			<option value="17"></option>
			<option value="18"></option>
			<option value="19"></option>
			<option value="20"></option>
		</datalist>
		<datalist id="destinoOpciones"></datalist>
		<datalist id="economicoOpciones"></datalist>
		<datalist id="unidadOpciones"></datalist>
		<datalist id="operadorOpciones"></datalist>
		<datalist id="inicioOpciones">
			<option value="Macro"></option>
			<option value="Central"></option>
		</datalist>

		<!-- MODAL CONBOY - Acomodador de Unidades -->
		<div id="conboyModal" class="conboy-modal" style="display: none;" aria-hidden="true">
			<div class="conboy-container">
				<div class="conboy-header">
					<h3>
						<span>üöö CONBOY - Acomodador de Unidades</span>
						<span id="conboyDateLabel" class="conboy-date-label"></span>
					</h3>
					<button type="button" class="conboy-close" id="conboyClose">‚úï</button>
				</div>
				<div class="conboy-content">
					<div class="conboy-section">
						<h4>Unidades Disponibles</h4>
						<div id="conboyAvailableUnits" class="conboy-units-list"></div>
					</div>
					<div class="conboy-section">
						<h4>Grupos Formados</h4>
						<div id="conboyGroups" class="conboy-groups-container"></div>
						<button type="button" class="secondary" id="conboyAddGroup">+ Crear Grupo</button>
					</div>
				</div>
				<div class="conboy-footer">
					<button type="button" class="danger" id="conboyClear">Limpiar</button>
					<button type="button" class="primary" id="conboyApply">Aplicar Cambios</button>
				</div>
			</div>
		</div>

		<script>
			const tableBody = document.getElementById("tableBody");
			const addRowButton = document.getElementById("addRow");
			const saveDraftButton = document.getElementById("saveDraft");
			const sendButton = document.getElementById("sendRow");
			const toggleColumnsButton = document.getElementById("toggleColumns");
			const clearButton = document.getElementById("clearTable");
			const currentDate = document.getElementById("currentDate");
			const destinoOpciones = document.getElementById("destinoOpciones");
			const economicoOpciones = document.getElementById("economicoOpciones");
			const unidadOpciones = document.getElementById("unidadOpciones");
			const operadorOpciones = document.getElementById("operadorOpciones");
			const tabBorrador = document.getElementById("tabBorrador");
			const tabLogistica = document.getElementById("tabLogistica");
			const borradorSection = document.getElementById("borradorSection");
			const logisticaSection = document.getElementById("logisticaSection");
			const logisticaTitle = document.getElementById("logisticaTitle");
			const logisticaDate = document.getElementById("logisticaDate");
			const logisticaLists = document.getElementById("logisticaLists");
			const printLogisticaButton = document.getElementById("printLogistica");
			const logisticaSearchInput = document.getElementById("logisticaSearchDate");
			const logisticaSearchButton = document.getElementById("logisticaSearchBtn");
			const logisticaSaveChangesButton = document.getElementById(
				"logisticaSaveChanges"
			);
			const showLogisticaColumnsButton = document.getElementById(
				"showLogisticaColumns"
			);
			const logisticaColumnPanel = document.getElementById(
				"logisticaColumnPanel"
			);
			const logisticaColumnSummary = document.getElementById(
				"logisticaColumnSummary"
			);
			const logisticaColumnToggles = document.getElementById(
				"logisticaColumnToggles"
			);
			const borradorColumnPanel = document.getElementById("borradorColumnPanel");
			const borradorColumnSummary = document.getElementById(
				"borradorColumnSummary"
			);
			const borradorColumnToggles = document.getElementById(
				"borradorColumnToggles"
			);
			const conboyModal = document.getElementById("conboyModal");
			const conboyClose = document.getElementById("conboyClose");
			const conboyDateLabel = document.getElementById("conboyDateLabel");
			const conboyAvailableUnits = document.getElementById("conboyAvailableUnits");
			const conboyGroups = document.getElementById("conboyGroups");
			const conboyAddGroup = document.getElementById("conboyAddGroup");
			const conboyClear = document.getElementById("conboyClear");
			const conboyApply = document.getElementById("conboyApply");
			const conboyPrintSummary = document.getElementById("conboyPrintSummary");

			const STORAGE_KEY = "cubicaje-hoja-libre";
			const STORAGE_LOGISTICA = "cubicaje-logistica-dia";
			const SHEETDB_ID = "mrrlieg6zoleg";
			const SHEETDB_TAB = "logistica";
			const SHEETDB_TAB_FLOTA = "flota";
			const SHEETDB_TAB_BORRADOR = "borrador";
			const SHEETDB_TAB_LOGISTICA = "hoja de logistica";

			const columns = [
				{ key: "almacen", type: "text", list: "almacenOpciones" },
				{ key: "destino", type: "text", list: "destinoOpciones" },
				{ key: "ubicacion", type: "text" },
				{ key: "coordenadas", type: "text" },
				{ key: "cantidadAuto", type: "number", extra: true },
				{ key: "cantidadCamion", type: "number", extra: true },
				{ key: "otras", type: "text", extra: true },
				{ key: "llantas", type: "number", extra: true, readOnly: true },
				{ key: "economico", type: "text", list: "economicoOpciones" },
				{ key: "unidad", type: "text" },
				{ key: "operador", type: "text" },
				{ key: "acompanante", type: "text", extra: true },
				{ key: "ordenCarga", type: "text", extra: true },
				{ key: "empezar", type: "datalist", extra: true },
			];

			const logisticaHideableKeys = new Set([
				"ubicacion",
				"coordenadas",
				"unidad",
				"operador",
				"acompanante",
			]);
			const borradorHideableKeys = new Set([
				"ubicacion",
				"coordenadas",
				"llantas",
				"unidad",
				"operador",
				"acompanante",
			]);
			const borradorHiddenColumns = new Set([
				"ubicacion",
				"coordenadas",
				"llantas",
				"unidad",
				"operador",
			]);
			const logisticaColumnKeys = [
				"fecha",
				"destino",
				"ordenCarga",
				"almacen",
				"cantidadAuto",
				"cantidadCamion",
				"otras",
				"economico",
				"empezar",
				"ubicacion",
				"coordenadas",
				"llantas",
				"unidad",
				"operador",
				"acompanante",
				"cartaPorte",
				"factura",
				"traspaso",
			];

			const pdfColumnKeys = new Set([
				"almacen",
				"destino",
				"cantidadAuto",
				"cantidadCamion",
				"otras",
				"economico",
				"ordenCarga",
				"empezar",
			]);

			let columnsHidden = true;

			const switchTab = (tab) => {
				const isLogistica = tab === "logistica";
				borradorSection.classList.toggle("active", !isLogistica);
				logisticaSection.classList.toggle("active", isLogistica);
				tabBorrador.classList.toggle("active", !isLogistica);
				tabLogistica.classList.toggle("active", isLogistica);
				document.body.classList.toggle("logistica-active", isLogistica);
				if (isLogistica && borradorColumnPanel) {
					borradorColumnPanel.classList.remove("open");
					borradorColumnPanel.setAttribute("aria-hidden", "true");
					toggleColumnsButton.textContent = "Mostrar columnas ocultas";
				}
			};

			const getBorradorColumnKeys = () =>
				Array.from(
					borradorSection?.querySelectorAll("th[data-column]") || []
				).map((header) => header.dataset.column).filter(Boolean);

			const applyBorradorColumnVisibility = () => {
				const headers = Array.from(
					borradorSection?.querySelectorAll("thead th[data-column]") || []
				);
				const indexMap = new Map();
				headers.forEach((header, index) => {
					const key = header.dataset.column;
					if (!key) return;
					indexMap.set(key, index);
				});
				getBorradorColumnKeys().forEach((key) => {
					const hidden = borradorHiddenColumns.has(key);
					borradorSection
						?.querySelectorAll(`[data-column="${key}"]`)
						.forEach((cell) => {
							cell.classList.toggle("hidden-column", hidden);
						});
					const columnIndex = indexMap.get(key);
					if (columnIndex === undefined) return;
					Array.from(tableBody?.querySelectorAll("tr") || []).forEach((row) => {
						const cell = row.children[columnIndex];
						if (!cell) return;
						cell.classList.toggle("hidden-column", hidden);
					});
				});
			};

			const getBorradorColumnLabel = (key) => {
				const header = borradorSection?.querySelector(
					`th[data-column="${key}"]`
				);
				return header ? header.textContent.trim() : key;
			};

			const updateBorradorColumnSummary = () => {
				if (!borradorColumnSummary) return;
				const hidden = Array.from(borradorHiddenColumns)
					.map((key) => getBorradorColumnLabel(key))
					.filter(Boolean);
				borradorColumnSummary.textContent = hidden.length
					? `Ocultas: ${hidden.join(", ")}`
					: "Ocultas: ninguna";
			};

			const renderBorradorColumnToggles = () => {
				if (!borradorColumnToggles) return;
				borradorColumnToggles.innerHTML = "";
				getBorradorColumnKeys().forEach((key) => {
					const label = document.createElement("label");
					label.className = "column-toggle";
					const checkbox = document.createElement("input");
					checkbox.type = "checkbox";
					checkbox.checked = !borradorHiddenColumns.has(key);
					checkbox.addEventListener("change", () => {
						if (checkbox.checked) {
							borradorHiddenColumns.delete(key);
						} else {
							borradorHiddenColumns.add(key);
						}
						applyBorradorColumnVisibility();
						updateBorradorColumnSummary();
					});
					const text = document.createElement("span");
					text.textContent = getBorradorColumnLabel(key);
					label.appendChild(checkbox);
					label.appendChild(text);
					borradorColumnToggles.appendChild(label);
				});
				updateBorradorColumnSummary();
			};


			const formatDate = () => {
				const today = new Date();
				currentDate.textContent = `Fecha: ${today.toLocaleDateString("es-MX", {
					weekday: "long",
					year: "numeric",
					month: "long",
					day: "numeric",
				})}`;
			};

			const hasRowContent = (row) =>
				columns.some((column) => String(row?.[column.key] || "").trim() !== "");

			const hasLogisticaRowContent = (row) =>
				logisticaColumnKeys.some(
					(key) => String(row?.[key] || "").trim() !== ""
				);

			const getLogisticaGroupComment = (rows) => {
				if (!Array.isArray(rows)) return "";
				const match = rows.find(
					(row) => String(row?.comentariosGrupo || "").trim() !== ""
				);
				return match ? String(match.comentariosGrupo || "") : "";
			};

			const loadLocalData = () => {
				const saved = localStorage.getItem(STORAGE_KEY);
				if (!saved) {
					addRow();
					return;
				}
				try {
					const rows = JSON.parse(saved);
					if (!Array.isArray(rows) || rows.length === 0) {
						addRow();
						return;
					}
					rows.forEach((row) => addRow(row));
				} catch (error) {
					console.error("Error al cargar datos", error);
					addRow();
				}
			};

			const normalizeKey = (value) =>
				String(value || "")
					.normalize("NFD")
					.replace(/[\u0300-\u036f]/g, "")
					.toLowerCase()
					.replace(/[^a-z0-9]+/g, " ")
					.trim();

			const buildRowKeyMap = (row) => {
				const map = new Map();
				Object.keys(row || {}).forEach((key) => {
					const normalized = normalizeKey(key);
					if (normalized && !map.has(normalized)) {
						map.set(normalized, row[key]);
					}
				});
				return map;
			};

			const pickValue = (row, keys) => {
				if (!row) return "";
				const keyMap = buildRowKeyMap(row);
				for (const key of keys) {
					const normalized = normalizeKey(key);
					if (keyMap.has(normalized)) {
						const value = keyMap.get(normalized);
						return value !== undefined && value !== null ? String(value) : "";
					}
				}
				return "";
			};

			const mapSheetRowToData = (row) => ({
				fecha: pickValue(row, ["Fecha"]).replace(/^'/, ""), // Remover comilla prefijo
				almacen: pickValue(row, ["Almac√©n", "Almacen"]),
				destino: pickValue(row, ["Destino"]),
				ubicacion: pickValue(row, ["Ubicaci√≥n", "Ubicacion"]),
				coordenadas: pickValue(row, ["Coordenadas", "Cordenadas"]),
				cantidadAuto: pickValue(row, ["Cant. Auto", "Cant Auto"]),
				cantidadCamion: pickValue(row, ["Cant. Cami√≥n", "Cant. Camion", "Cant Camion"]),
				otras: pickValue(row, ["Otras"]),
				llantas: pickValue(row, ["Llantas"]),
				economico: pickValue(row, ["Econ√≥mico", "Economico"]),
				unidad: pickValue(row, ["Unidad"]),
				operador: pickValue(row, ["Operador"]),
				acompanante: pickValue(row, ["Acompa√±ante", "Acompanante"]),
				ordenCarga: pickValue(row, ["Orden de carga", "orden de carga", "Orden de Carga"]),
				empezar: pickValue(row, ["Empezar a cargar", "Empezar"]),
				cartaPorte: pickValue(row, ["carta porte", "Carta porte", "Carta Porte"]),
				factura: pickValue(row, ["factura", "Factura"]),
				traspaso: pickValue(row, ["traspaso", "Traspaso"]),
				comentariosGrupo: pickValue(row, ["Comentarios", "Comentario", "Comentarios grupo"]),
			});

			const mapDataToSheetRow = (row) => ({
				"Fecha": row.fecha ? `'${row.fecha}` : "", // Prefijo ' fuerza formato texto en SheetDB
				"Almac√©n": row.almacen || "",
				"Destino": row.destino || "",
				"Ubicaci√≥n": row.ubicacion || "",
				"Coordenadas": row.coordenadas || "",
				"Cant. Auto": row.cantidadAuto || "",
				"Cant. Cami√≥n": row.cantidadCamion || "",
				"Otras": row.otras || "",
				"Llantas": row.llantas || "",
				"Econ√≥mico": row.economico || "",
				"Unidad": row.unidad || "",
				"Operador": row.operador || "",
				"Acompa√±ante": row.acompanante || "",
				"orden de carga": row.ordenCarga || "",
				"Empezar a cargar": row.empezar || "",
				"carta porte": row.cartaPorte || "",
				"factura": row.factura || "",
				"traspaso": row.traspaso || "",
				"Comentarios": row.comentariosGrupo || "",
			});

			const logisticaGroupNotes = new Map();

			const getLogisticaGroupNotesFromDom = () => {
				const map = new Map();
				if (!logisticaLists) return map;
				logisticaLists
					.querySelectorAll("textarea[data-group-comment='true']")
					.forEach((textarea) => {
						const key = textarea.dataset.fechaKey || "";
						map.set(key, textarea.value || "");
					});
				return map;
			};

			const mapDataToSheetRowBorrador = (row) => ({
				"Almac√©n": row.almacen || "",
				"Destino": row.destino || "",
				"Ubicaci√≥n": row.ubicacion || "",
				"Coordenadas": row.coordenadas || "",
				"Cant. Auto": row.cantidadAuto || "",
				"Cant. Cami√≥n": row.cantidadCamion || "",
				"Otras": row.otras || "",
				"Llantas": row.llantas || "",
				"Econ√≥mico": row.economico || "",
				"Unidad": row.unidad || "",
				"Operador": row.operador || "",
				"Acompa√±ante": row.acompanante || "",
				"orden de carga": row.ordenCarga || "",
				"Empezar a cargar": row.empezar || "",
			});

			const loadBorradorFromApi = async () => {
				try {
					const response = await fetch(
						`https://sheetdb.io/api/v1/${SHEETDB_ID}?sheet=${encodeURIComponent(
							SHEETDB_TAB_BORRADOR
						)}`
					);
					if (!response.ok) throw new Error("Respuesta inv√°lida");
					const data = await response.json();
					if (!Array.isArray(data) || data.length === 0) return [];
					return data
						.map((row) => mapSheetRowToData(row))
						.filter((row) => hasRowContent(row));
				} catch (error) {
					console.error("No se pudo cargar borrador", error);
					return [];
				}
			};

			const loadLogisticaFromApi = async () => {
				try {
					const response = await fetch(
						`https://sheetdb.io/api/v1/${SHEETDB_ID}?sheet=${encodeURIComponent(
							SHEETDB_TAB_LOGISTICA
						)}`
					);
					if (!response.ok) throw new Error("Respuesta inv√°lida");
					const data = await response.json();
					if (!Array.isArray(data) || data.length === 0) return [];
					return data
						.map((row) => mapSheetRowToData(row))
						.filter((row) => hasRowContent(row));
				} catch (error) {
					console.error("No se pudo cargar log√≠stica", error);
					return [];
				}
			};

			const loadData = async () => {
				const apiRows = await loadBorradorFromApi();
				if (apiRows.length > 0) {
					apiRows.forEach((row) => addRow(row));
					return;
				}
				loadLocalData();
			};

			let logisticaRowsFromApi = [];

			const loadLogisticaData = async () => {
				const apiRows = await loadLogisticaFromApi();
				if (apiRows.length > 0) {
					logisticaRowsFromApi = apiRows;
					localStorage.setItem(STORAGE_LOGISTICA, JSON.stringify(apiRows));
					return;
				}
				localStorage.removeItem(STORAGE_LOGISTICA);
				logisticaRowsFromApi = [];
			};

			const saveData = () => {
				const rows = Array.from(tableBody.querySelectorAll("tr")).map(
					(row) => {
						const data = {};
						columns.forEach((column) => {
							const input = row.querySelector(`input[data-key="${column.key}"]`);
							data[column.key] = input ? input.value : "";
						});
						return data;
					}
				);
				localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
			};

			let destinoCatalogo = [];
			let destinoIndex = new Map();
			let flotaCatalogo = [];
			let economicoIndex = new Map();

			const buildDestinoIndex = (rows) => {
				destinoIndex = new Map();
				rows.forEach((row) => {
					const destino = (row.DESTINO || "").trim();
					if (destino) {
						destinoIndex.set(destino.toLowerCase(), {
							destino,
							direccion: (row.DIRECCION || "").trim(),
							coordenadas: (row.CORDENADAS || "").trim(),
						});
					}
				});
			};

			const renderDestinoOpciones = (rows) => {
				destinoOpciones.innerHTML = "";
				rows.forEach((row) => {
					const destino = (row.DESTINO || "").trim();
					if (!destino) return;
					const option = document.createElement("option");
					option.value = destino;
					destinoOpciones.appendChild(option);
				});
			};

			const buildEconomicoIndex = (rows) => {
				economicoIndex = new Map();
				rows.forEach((row) => {
					const economico = (row.economico || row.ECONOMICO || "").trim();
					if (economico) {
						economicoIndex.set(economico.toLowerCase(), {
							economico,
							unidad: (row.unidad || row.UNIDAD || "").trim(),
							operador: (row.encargado || row.ENCARGADO || "").trim(),
						});
					}
				});
			};

			const renderEconomicoOpciones = (rows) => {
				economicoOpciones.innerHTML = "";
				rows.forEach((row) => {
					const economico = (row.economico || row.ECONOMICO || "").trim();
					if (!economico) return;
					const option = document.createElement("option");
					option.value = economico;
					economicoOpciones.appendChild(option);
				});
			};

			const renderUnidadOpciones = (rows) => {
				unidadOpciones.innerHTML = "";
				const unique = new Set();
				rows.forEach((row) => {
					const unidad = (row.unidad || row.UNIDAD || "").trim();
					if (unidad) unique.add(unidad);
				});
				Array.from(unique).forEach((unidad) => {
					const option = document.createElement("option");
					option.value = unidad;
					unidadOpciones.appendChild(option);
				});
			};

			const renderOperadorOpciones = (rows) => {
				operadorOpciones.innerHTML = "";
				const unique = new Set();
				rows.forEach((row) => {
					const operador = (row.encargado || row.ENCARGADO || "").trim();
					if (operador) unique.add(operador);
				});
				Array.from(unique).forEach((operador) => {
					const option = document.createElement("option");
					option.value = operador;
					operadorOpciones.appendChild(option);
				});
			};

			const loadDestinoData = async () => {
				try {
					const response = await fetch(
						`https://sheetdb.io/api/v1/${SHEETDB_ID}?sheet=${encodeURIComponent(
							SHEETDB_TAB
						)}`
					);
					if (!response.ok) throw new Error("Respuesta inv√°lida");
					const data = await response.json();
					if (Array.isArray(data)) {
						destinoCatalogo = data;
						buildDestinoIndex(data);
						renderDestinoOpciones(data);
					}
				} catch (error) {
					console.error("No se pudo cargar SheetDB", error);
				}
			};

			const loadFlotaData = async () => {
				try {
					const response = await fetch(
						`https://sheetdb.io/api/v1/${SHEETDB_ID}?sheet=${encodeURIComponent(
							SHEETDB_TAB_FLOTA
						)}`
					);
					if (!response.ok) throw new Error("Respuesta inv√°lida");
					const data = await response.json();
					if (Array.isArray(data)) {
						flotaCatalogo = data;
						buildEconomicoIndex(data);
						renderEconomicoOpciones(data);
						renderUnidadOpciones(data);
						renderOperadorOpciones(data);
					}
				} catch (error) {
					console.error("No se pudo cargar flota", error);
				}
			};

			const applyDestinoAutoFill = (row, destinoValue) => {
				const record = destinoIndex.get(destinoValue.toLowerCase());
				if (!record) return;
				const ubicacionInput = row.querySelector("input[data-key='ubicacion']");
				const coordenadasInput = row.querySelector(
					"input[data-key='coordenadas']"
				);
				if (ubicacionInput) ubicacionInput.value = record.direccion;
				if (coordenadasInput) coordenadasInput.value = record.coordenadas;
				saveData();
			};

			const applyEconomicoAutoFill = (row, economicoValue) => {
				const record = economicoIndex.get(economicoValue.toLowerCase());
				if (!record) return;
				const unidadInput = row.querySelector("input[data-key='unidad']");
				const operadorInput = row.querySelector("input[data-key='operador']");
				if (unidadInput) unidadInput.value = record.unidad;
				if (operadorInput) operadorInput.value = record.operador;
				saveData();
			};

			const createInput = (column, value = "") => {
				const input = document.createElement("input");
				input.value = value;
				input.dataset.key = column.key;

				if (column.type === "number") {
					input.type = "number";
					input.min = "0";
				} else if (column.type === "datalist") {
					input.type = "text";
					input.setAttribute("list", "inicioOpciones");
				} else {
					input.type = column.type;
				}

				if (column.list) {
					input.setAttribute("list", column.list);
				}

				if (column.readOnly) {
					input.readOnly = true;
					input.tabIndex = -1;
				}

				if (column.key === "llantas") {
					input.placeholder = "0";
				}

				if (column.key === "empezar") {
					input.classList.add("wide-input");
				}

				input.addEventListener("input", saveData);

				if (column.key === "destino") {
					input.addEventListener("change", (event) => {
						const row = event.target.closest("tr");
						if (!row) return;
						applyDestinoAutoFill(row, event.target.value || "");
					});
					input.addEventListener("blur", (event) => {
						const row = event.target.closest("tr");
						if (!row) return;
						applyDestinoAutoFill(row, event.target.value || "");
					});
				}

				if (column.key === "economico") {
					input.addEventListener("change", (event) => {
						const row = event.target.closest("tr");
						if (!row) return;
						applyEconomicoAutoFill(row, event.target.value || "");
					});
					input.addEventListener("blur", (event) => {
						const row = event.target.closest("tr");
						if (!row) return;
						applyEconomicoAutoFill(row, event.target.value || "");
					});
				}

				return input;
			};

			const sumNumbers = (value) => {
				const matches = String(value || "").match(/-?\d+(?:\.\d+)?/g);
				if (!matches) return 0;
				return matches.reduce((total, match) => {
					const numberValue = Number(match);
					return total + (Number.isFinite(numberValue) ? Math.abs(numberValue) : 0);
				}, 0);
			};

			const updateLlantasValue = (row) => {
				if (!row) return;
				const autoInput = row.querySelector("input[data-key='cantidadAuto']");
				const camionInput = row.querySelector("input[data-key='cantidadCamion']");
				const otrasInput = row.querySelector("input[data-key='otras']");
				const llantasInput = row.querySelector("input[data-key='llantas']");
				if (!llantasInput) return;
				const total =
					sumNumbers(autoInput?.value) +
					sumNumbers(camionInput?.value) +
					sumNumbers(otrasInput?.value);
				llantasInput.value = total > 0 ? String(total) : "";
			};

			const updateBorradorRowHighlight = (row) => {
				if (!row) return;
				const inputs = Array.from(row.querySelectorAll("input[data-key]"));
				const hasValue = inputs.some((input) =>
					String(input.value || "").trim() !== ""
				);
				row.classList.toggle("unit-group", hasValue);
				if (!hasValue) {
					row.classList.remove("unit-group-alt");
				}
			};

			const getRowDataFromRow = (row) => {
				const data = {};
				columns.forEach((column) => {
					const input = row.querySelector(`input[data-key="${column.key}"]`);
					data[column.key] = input ? input.value : "";
				});
				return data;
			};

			const unitFields = new Set([
				"economico",
				"unidad",
				"operador",
				"acompanante",
				"empezar",
			]);

			let unitGroupCounter = 0;

			const buildUnitRowData = (source) => {
				const data = { ...source };
				unitFields.forEach((key) => {
					data[key] = "";
				});
				data.llantas = "";
				return data;
			};

			const applyUnitGroup = (row, groupId) => {
				if (!row || groupId === null || groupId === undefined) return;
				row.dataset.unitGroup = String(groupId);
				row.classList.add("unit-group");
				if (groupId % 2 === 0) {
					row.classList.add("unit-group-alt");
				} else {
					row.classList.remove("unit-group-alt");
				}
			};

			const promptForUnits = (row) => {
				if (!row || row.dataset.unitsPrompted === "true") return;
				const response = window.prompt(
					"¬øCuantas unidades deseas a√±adir para este cliente?",
					"1"
				);
				if (response === null) return;
				const requested = Number.parseInt(String(response).trim(), 10);
				if (!Number.isFinite(requested) || requested < 1) return;
				const totalUnits = Math.min(requested, 20);
				row.dataset.unitsPrompted = "true";
				if (totalUnits === 1) return;
				unitGroupCounter += 1;
				const groupId = unitGroupCounter;
				applyUnitGroup(row, groupId);
				const sourceData = getRowDataFromRow(row);
				const unitData = buildUnitRowData(sourceData);
				let insertAfter = row;
				for (let index = 1; index < totalUnits; index += 1) {
					const newRow = addRow(unitData, {
						afterRow: insertAfter,
						groupId,
					});
					newRow.dataset.unitsPrompted = "true";
					insertAfter = newRow;
				}
			};

			const createRowElement = (rowData = {}, groupId = null) => {
				const row = document.createElement("tr");

				columns.forEach((column) => {
					const cell = document.createElement("td");
					cell.dataset.column = column.key;
					if (borradorHideableKeys.has(column.key)) {
						cell.dataset.hide = "true";
						if (borradorHiddenColumns.has(column.key)) {
							cell.classList.add("hidden-column");
						}
					}
					const input = createInput(column, rowData[column.key] || "");
					input.addEventListener("input", () => updateBorradorRowHighlight(row));
					cell.appendChild(input);
					row.appendChild(cell);
				});

				const autoInput = row.querySelector("input[data-key='cantidadAuto']");
				const camionInput = row.querySelector("input[data-key='cantidadCamion']");
				const otrasInput = row.querySelector("input[data-key='otras']");
				[autoInput, camionInput, otrasInput].forEach((input) => {
					if (!input) return;
					input.addEventListener("input", () => {
						updateLlantasValue(row);
						saveData();
					});
				});

				const llantasInput = row.querySelector("input[data-key='llantas']");
				if (llantasInput) {
					llantasInput.addEventListener("mouseenter", () => promptForUnits(row));
					llantasInput.addEventListener("focus", () => promptForUnits(row));
				}

				const actionsCell = document.createElement("td");
				actionsCell.dataset.column = "acciones";
				if (borradorHiddenColumns.has("acciones")) {
					actionsCell.classList.add("hidden-column");
				}
				const actions = document.createElement("div");
				actions.className = "row-actions";
				const deleteButton = document.createElement("button");
				deleteButton.textContent = "Eliminar";
				deleteButton.className = "danger";
				deleteButton.type = "button";
				deleteButton.addEventListener("click", () => {
					row.remove();
					if (tableBody.children.length === 0) {
						addRow();
					}
					saveData();
					applyBorradorRowColors();
				});
				actions.appendChild(deleteButton);
				actionsCell.appendChild(actions);
				row.appendChild(actionsCell);

				applyUnitGroup(row, groupId);
				updateBorradorRowHighlight(row);

				return row;
			};

			const applyBorradorRowColors = () => {
				let visibleIndex = 0;
				Array.from(tableBody.querySelectorAll("tr")).forEach((row) => {
					row.classList.remove("row-alt", "row-alt-2");
					if (row.classList.contains("unit-group")) {
						return;
					}
					if (visibleIndex % 2 === 0) {
						row.classList.add("row-alt");
					} else {
						row.classList.add("row-alt-2");
					}
					visibleIndex += 1;
				});
			};

			const addRow = (rowData = {}, options = {}) => {
				const row = createRowElement(rowData, options.groupId ?? null);
				if (options.afterRow) {
					tableBody.insertBefore(row, options.afterRow.nextSibling);
				} else {
					tableBody.appendChild(row);
				}
				applyBorradorColumnVisibility();
				updateBorradorColumnSummary();
				updateLlantasValue(row);
				saveData();
				applyBorradorRowColors();
				return row;
			};

			const getCurrentRows = () =>
				Array.from(tableBody.querySelectorAll("tr")).map((row) => {
					const data = {};
					columns.forEach((column) => {
						const input = row.querySelector(`input[data-key="${column.key}"]`);
						data[column.key] = input ? input.value : "";
					});
					return data;
				});

			const getLogisticaBodies = () =>
				Array.from(logisticaLists?.querySelectorAll("tbody") || []);

			const getLogisticaRowsFromTable = () =>
				getLogisticaBodies().flatMap((body) =>
					Array.from(body.querySelectorAll("tr"))
						.filter((row) => !row.classList.contains("logistica-comment-row"))
						.map((row) => {
						const data = {};
						logisticaColumnKeys.forEach((key, index) => {
							const cell = row.children[index];
							if (!cell) {
								data[key] = "";
								return;
							}
							const inputs = Array.from(
								cell.querySelectorAll("textarea, input")
							);
							if (inputs.length === 0) {
								data[key] = "";
								return;
							}
							if (inputs.length === 1) {
								data[key] = inputs[0].value || "";
								return;
							}
							data[key] = inputs
								.map((input) => String(input.value || "").trim())
								.filter((value) => value !== "")
								.join(" ¬∑ ");
						});
							return data;
						})
				);

// Funci√≥n para detectar si dos objetos de fila son iguales
		const areRowsEqual = (row1, row2) => {
			if (!row1 || !row2) return row1 === row2;
			for (const key of logisticaColumnKeys) {
				const val1 = (row1[key] || "").trim();
				const val2 = (row2[key] || "").trim();
				if (val1 !== val2) return false;
			}
				const comment1 = String(row1.comentariosGrupo || "").trim();
				const comment2 = String(row2.comentariosGrupo || "").trim();
				if (comment1 !== comment2) return false;
			return true;
		};

		// Funci√≥n para encontrar cambios espec√≠ficos entre dos conjuntos de filas
		const findLogisticaChanges = (currentRows, originalRows) => {
			const changes = {
				updated: [],
				added: [],
				removed: [],
			};

			// Detectar filas actualizadas
			currentRows.forEach((currentRow) => {
				const originalRow = originalRows.find((orig) =>
					areRowsEqual(orig, currentRow)
				);
				if (!originalRow) {
					// No es exactamente igual, podr√≠a ser actualizada
					const similar = originalRows.find(
						(orig) =>
							orig.fecha === currentRow.fecha &&
							orig.economico === currentRow.economico &&
							orig.destino === currentRow.destino
					);
					if (similar) {
						changes.updated.push(currentRow);
					} else {
						changes.added.push(currentRow);
					}
				}
			});

			// Detectar filas eliminadas
			originalRows.forEach((originalRow) => {
				const found = currentRows.find((curr) => areRowsEqual(curr, originalRow));
				if (!found) {
					changes.removed.push(originalRow);
				}
			});

			return changes;
		};

		// Funci√≥n para actualizar una fila espec√≠fica en la hoja (PUT)
		const updateRowInSheet = async (sheetName, searchCriteria, newData) => {
			const baseUrl = `https://sheetdb.io/api/v1/${SHEETDB_ID}`;
			
			// Mapear los datos nuevos
			const mappedData = mapDataToSheetRow(newData);
			
			try {
				const response = await fetch(
					`${baseUrl}?sheet=${encodeURIComponent(sheetName)}`,
					{
						method: "PATCH",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({
							data: newData ? [mappedData] : [],
							search: searchCriteria,
						}),
					}
				);
				
				if (!response.ok) {
					const details = await response.text();
					throw new Error(
						`No se pudo actualizar fila en la hoja (${response.status}). ${details}`
					);
				}
				return true;
			} catch (error) {
				console.warn("PATCH no soportado, intentando DELETE + INSERT", error);
				return false;
			}
		};

		const saveLogisticaChanges = async () => {
			const currentRows = getLogisticaRowsFromTable().filter((row) =>
				hasLogisticaRowContent(row)
			);
			if (currentRows.length === 0) {
				alert("No hay datos para guardar.");
				return false;
			}

			try {
					const groupNotes = getLogisticaGroupNotesFromDom();
				// Formatear fechas como texto (prefijo con comilla para que NOT sean n√∫meros)
				const rowsWithFormattedDates = currentRows.map((row) => ({
					...row,
						fecha: row.fecha ? `${row.fecha}` : "",
						comentariosGrupo:
							groupNotes.get(normalizeSearchValue(row.fecha || "")) ||
							row.comentariosGrupo ||
							"",
				}));

				// Para minimizar reescrituras, comparamos con datos originales
				const changes = findLogisticaChanges(
					rowsWithFormattedDates,
					logisticaRowsFromApi
				);

				// Si no hay cambios materiales, no hacer nada
				if (
					changes.updated.length === 0 &&
					changes.added.length === 0 &&
					changes.removed.length === 0
				) {
					alert("No hay cambios para guardar.");
					return false;
				}

				// Si hay cambios, reescrever solo lo necesario
				// Intentar actualizar de form inteligente primero
				let updateSuccess = false;

				// Si solo hay cambios en una fila espec√≠fica, intentar PUT directo
				if (
					changes.updated.length === 1 &&
					changes.added.length === 0 &&
					changes.removed.length === 0
				) {
					const updatedRow = changes.updated[0];
					const originalRow = logisticaRowsFromApi.find(
						(orig) =>
							orig.fecha === updatedRow.fecha &&
							orig.economico === updatedRow.economico &&
							orig.destino === updatedRow.destino
					);

					if (originalRow) {
						updateSuccess = await updateRowInSheet(
							SHEETDB_TAB_LOGISTICA,
							{
								Fecha: originalRow.fecha,
								Econ√≥mico: originalRow.economico,
								Destino: originalRow.destino,
							},
							updatedRow
						);
					}
				}

				// Si el UPDATE espec√≠fico no funcion√≥, usar el m√©todo de reescritura
				if (!updateSuccess) {
					try {
						await sendRowsToSheet(SHEETDB_TAB_LOGISTICA, rowsWithFormattedDates);
					} catch (error) {
						console.warn("Fallo limpieza, se intenta agregar", error);
						await sendRowsToSheet(SHEETDB_TAB_LOGISTICA, rowsWithFormattedDates, null, {
							clearFirst: false,
						});
					}
				}

				logisticaRowsFromApi = rowsWithFormattedDates;
				localStorage.setItem(STORAGE_LOGISTICA, JSON.stringify(rowsWithFormattedDates));
				renderLogistica(rowsWithFormattedDates);
					loadLogisticaData().catch((error) =>
						console.error("Error al recargar log√≠stica", error)
					);
					return true;
				} catch (error) {
					console.error("No se pudo guardar cambios de log√≠stica", error);
					alert(
						`No se pudo guardar cambios. ${error?.message || "Intenta de nuevo."}`
					);
					return false;
				}
			};

			const getLogisticaRowsForView = () => {
				if (logisticaRowsFromApi.length > 0) return logisticaRowsFromApi;
				const currentRows = getCurrentRows().filter((row) => hasRowContent(row));
				if (currentRows.length > 0) return currentRows;
				return [];
			};

			let savingBorrador = false;
			let pendingBorradorSave = false;

			const chunkRows = (rows, size) => {
				const chunks = [];
				for (let index = 0; index < rows.length; index += size) {
					chunks.push(rows.slice(index, index + size));
				}
				return chunks;
			};

			const sendRowsToSheet = async (
				sheetName,
				rows,
				rowMapper = null,
				options = {}
			) => {
				const baseUrl = `https://sheetdb.io/api/v1/${SHEETDB_ID}`;
				const { clearFirst = true } = options;
				if (clearFirst) {
					const deleteResponse = await fetch(
						`${baseUrl}/all?sheet=${encodeURIComponent(sheetName)}`,
						{ method: "DELETE" }
					);
					if (!deleteResponse.ok) {
						const details = await deleteResponse.text();
						throw new Error(
							`No se pudo limpiar la hoja (${deleteResponse.status}). ${details}`
						);
					}
				}
				if (!rows || rows.length === 0) return;
				const mapper = rowMapper || mapDataToSheetRow;
				const chunks = chunkRows(rows, 200);
				for (const chunk of chunks) {
					const payload = {
						data: chunk.map((row) => mapper(row)),
					};
					const insertResponse = await fetch(
						`${baseUrl}?sheet=${encodeURIComponent(sheetName)}`,
						{
							method: "POST",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify(payload),
						}
					);
					if (!insertResponse.ok) {
						const details = await insertResponse.text();
						throw new Error(
							`No se pudo guardar en la hoja (${insertResponse.status}). ${details}`
						);
					}
				}
			};

			const saveBorradorToApi = async () => {
				if (savingBorrador) {
					pendingBorradorSave = true;
					return;
				}
				savingBorrador = true;
				try {
					await sendRowsToSheet(SHEETDB_TAB_BORRADOR, getCurrentRows());
				} catch (error) {
					console.error("No se pudo guardar el borrador", error);
				} finally {
					savingBorrador = false;
					if (pendingBorradorSave) {
						pendingBorradorSave = false;
						saveBorradorToApi();
					}
				}
			};


			const logisticaHiddenColumns = new Set();

			const applyLogisticaColumnVisibility = () => {
				logisticaColumnKeys.forEach((key) => {
					const hidden = logisticaHiddenColumns.has(key);
					document
						.querySelectorAll(`.logistica-table .col-${key}`)
						.forEach((cell) => {
							cell.classList.toggle("hidden-column", hidden);
						});
					document
						.querySelectorAll(
							`.logistica-table thead th[data-column="${key}"]`
						)
						.forEach((header) => {
							header.classList.toggle("hidden-column", hidden);
						});
				});
			};

			const getLogisticaColumnLabel = (key) => {
				const header = logisticaLists?.querySelector(
					`th[data-column="${key}"]`
				);
				return header ? header.textContent.trim() : key;
			};

			const updateLogisticaColumnSummary = () => {
				if (!logisticaColumnSummary) return;
				const hidden = logisticaColumnKeys
					.filter((key) => logisticaHiddenColumns.has(key))
					.map((key) => getLogisticaColumnLabel(key))
					.filter(Boolean);
				logisticaColumnSummary.textContent = hidden.length
					? `Ocultas: ${hidden.join(", ")}`
					: "Ocultas: ninguna";
			};

			const renderLogisticaColumnToggles = () => {
				if (!logisticaColumnToggles) return;
				logisticaColumnToggles.innerHTML = "";
				logisticaColumnKeys.forEach((key) => {
					const label = document.createElement("label");
					label.className = "column-toggle";
					const checkbox = document.createElement("input");
					checkbox.type = "checkbox";
					checkbox.checked = !logisticaHiddenColumns.has(key);
					checkbox.addEventListener("change", () => {
						if (checkbox.checked) {
							logisticaHiddenColumns.delete(key);
						} else {
							logisticaHiddenColumns.add(key);
						}
						applyLogisticaColumnVisibility();
						updateLogisticaColumnSummary();
					});
					const text = document.createElement("span");
					text.textContent = getLogisticaColumnLabel(key);
					label.appendChild(checkbox);
					label.appendChild(text);
					logisticaColumnToggles.appendChild(label);
				});
				updateLogisticaColumnSummary();
			};

			const getDateLabel = (sourceDate = null) => {
				if (typeof sourceDate === "string" && sourceDate.trim() !== "") {
					return sourceDate.trim();
				}
				const dateValue = sourceDate instanceof Date ? sourceDate : new Date();
				return dateValue.toLocaleDateString("es-MX", {
					weekday: "long",
					year: "numeric",
					month: "long",
					day: "numeric",
				});
			};

			const normalizeSearchValue = (value) =>
				String(value || "")
					.toLowerCase()
					.replace(/\s+/g, "")
					.replace(/[^0-9a-z/.-]/g, "");

			const renderConboyPrintSummary = (rows) => {
				if (!conboyPrintSummary) return;
				const escapeText = (value) =>
					String(value)
						.replace(/&/g, "&amp;")
						.replace(/</g, "&lt;")
						.replace(/>/g, "&gt;");
				const fallbackDate = new Date().toLocaleDateString("es-MX");
				const visibleDates = Array.from(
					logisticaLists?.querySelectorAll("details.accordion-item") || []
				)
					.filter((detail) => detail.style.display !== "none")
					.map((detail) => String(detail.dataset.fecha || "").trim())
					.filter(Boolean);
				const sourceDates = visibleDates.length
					? visibleDates
					: (rows || []).map((row) => {
							const rowDate = String(row.fecha || fallbackDate).trim();
							return rowDate || fallbackDate;
						});
				const uniqueDates = Array.from(new Set(sourceDates));
				const store = getConboyStore();
				const blocks = uniqueDates
					.map((dateValue) => {
						const dateKey = normalizeSearchValue(dateValue);
						const groups = Array.isArray(store[dateKey]) ? store[dateKey] : [];
						if (groups.length === 0) return "";
						const groupsHtml = groups
							.map((group) => {
								const economicos = Array.from(
									new Set(
										(group.units || [])
											.map((unit) => String(unit.economico || "").trim())
											.filter(Boolean)
									)
								);
								const ecoText = economicos.length
									? economicos.join(", ")
									: "Sin economico";
									const noteText = String(group.note || "").trim();
									return `
										<div class="conboy-print-group">
											<div class="conboy-print-title">${escapeText(
												group.name || "Grupo"
											)}</div>
											<div class="conboy-print-economicos">${escapeText(
												ecoText
											)}</div>
											${noteText ? `
												<div class="conboy-print-note">${escapeText(noteText)}</div>` : ""}
										</div>
									`;
							})
							.join("");
						return `
							<div class="conboy-print-date">
								${groupsHtml}
							</div>
						`;
					})
					.join("");
				if (!blocks.trim()) {
					conboyPrintSummary.innerHTML = "";
					conboyPrintSummary.setAttribute("aria-hidden", "true");
					return;
				}
				conboyPrintSummary.innerHTML = `
					<div class="conboy-print-heading">CONBOY</div>
					${blocks}
				`;
				conboyPrintSummary.setAttribute("aria-hidden", "false");
			};

			const applyLogisticaSearch = (query) => {
				if (!logisticaLists) return;
				const normalized = normalizeSearchValue(query);
				const details = Array.from(
					logisticaLists.querySelectorAll("details.accordion-item")
				);
				if (!normalized) {
					details.forEach((detail) => {
						detail.style.display = "";
						detail.open = false;
					});
					return;
				}
				const matches = [];
				const others = [];
				details.forEach((detail) => {
					const raw = normalizeSearchValue(detail.dataset.fecha || "");
					const label = normalizeSearchValue(detail.dataset.fechaLabel || "");
					const isMatch = raw === normalized || label === normalized;
					detail.style.display = isMatch ? "" : "none";
					detail.open = isMatch;
					(isMatch ? matches : others).push(detail);
				});
				if (matches.length > 0) {
					const fragment = document.createDocumentFragment();
					matches.forEach((detail) => fragment.appendChild(detail));
					others.forEach((detail) => fragment.appendChild(detail));
					logisticaLists.appendChild(fragment);
				}
			};

			const promptForLogisticaDate = () => {
				const fallbackDate = new Date().toLocaleDateString("es-MX");
				const response = window.prompt(
					"Fecha para esta logistica (ej: 06/02/2026):",
					fallbackDate
				);
				if (response === null) return null;
				const cleaned = String(response).trim();
				return cleaned || fallbackDate;
			};

			const renderLogistica = (rows) => {
				const dateLabel = getDateLabel();
				const numericDate = new Date().toLocaleDateString("es-MX");
				const uniqueFechas = Array.from(
					new Set(
						rows
							.map((row) => (row.fecha || "").trim())
							.filter((value) => value !== "")
					)
				);
				if (logisticaTitle) {
					const titleSuffix =
						uniqueFechas.length > 1
							? " "
							: uniqueFechas[0]
								? getDateLabel(uniqueFechas[0])
								: dateLabel;
					logisticaTitle.textContent = `Log√≠stica del d√≠a ¬∑ ${titleSuffix}`;
				}
				logisticaDate.textContent = `Fecha: ${dateLabel}`;
				if (!logisticaLists) return;

				const groupedByDate = new Map();
				rows.forEach((row) => {
					const rowDate = (row.fecha || numericDate).trim() || numericDate;
					if (!groupedByDate.has(rowDate)) {
						groupedByDate.set(rowDate, []);
					}
					groupedByDate.get(rowDate).push(row);
				});

				const uniqueLine = (items) =>
					Array.from(new Set(items.filter((item) => item && item.trim() !== "")));

				const joinInline = (items) => items.join(" ¬∑ ");

				const stackedColumnKeys = new Set([
					"almacen",
					"destino",
					"ubicacion",
					"coordenadas",
					"ordenCarga",
					"cantidadAuto",
					"cantidadCamion",
					"otras",
					"llantas",
				]);

				const escapeAttr = (value) =>
					String(value)
						.replace(/&/g, "&amp;")
						.replace(/"/g, "&quot;")
						.replace(/</g, "&lt;")
						.replace(/>/g, "&gt;");

				const escapeText = (value) =>
					String(value)
						.replace(/&/g, "&amp;")
						.replace(/</g, "&lt;")
						.replace(/>/g, "&gt;");

				const getGroupNoteForDate = (dateValue, dateRows) => {
					const dateKey = normalizeSearchValue(dateValue || "");
					if (logisticaGroupNotes.has(dateKey)) {
						return logisticaGroupNotes.get(dateKey) || "";
					}
					const initial = getLogisticaGroupComment(dateRows);
					logisticaGroupNotes.set(dateKey, initial);
					return initial;
				};

				const renderCommentRow = (dateValue, dateRows) => {
					const dateKey = normalizeSearchValue(dateValue || "");
					const value = getGroupNoteForDate(dateValue, dateRows);
					const colSpan = logisticaColumnKeys.length + 1;
					return `
						<tr class="logistica-comment-row">
							<td colspan="${colSpan}">
								<div class="logistica-comment-label print-hide">Comentarios</div>
								<textarea data-group-comment="true" data-fecha-key="${escapeAttr(
									dateKey
								)}" placeholder="Comentarios...">${escapeText(value)}</textarea>
							</td>
						</tr>
					`;
				};

				const buildDestinoSummary = (parts) => {
					if (!parts || parts.length === 0) return "";
					const first = parts[0];
					const extra = parts.length - 1;
					return extra > 0 ? `${first} +${extra}` : first;
				};

				const renderInput = (value, listId = "") => {
					if (listId) {
						return `<input type="text" value="${escapeAttr(value)}" list="${listId}" />`;
					}
					return `<textarea>${escapeText(value)}</textarea>`;
				};

				const renderStackedInputs = (value, listId = "", columnKey = "") => {
					const raw = String(value || "").trim();
					const parts = raw
						.split(" ¬∑ ")
						.map((part) => part.trim())
						.filter((part) => part !== "");
					if (parts.length === 0) {
						return renderInput("", listId);
					}
					const fields = parts
						.map((part, index) => {
							const field = listId
								? `<input class="stacked-field" type="text" value="${escapeAttr(
										part
									)}" list="${listId}" />`
								: `<textarea class="stacked-field">${escapeText(part)}</textarea>`;
							if (columnKey !== "destino") return field;
							return `<div class="stacked-field-row" data-index="${index + 1}">${field}</div>`;
						})
						.join("");
					const stackedFields = `<div class="stacked-fields">${fields}</div>`;
					if (columnKey !== "destino" || parts.length === 1) {
						return stackedFields;
					}
					const summary = escapeText(buildDestinoSummary(parts));
					return `
						<div class="destino-compact">
							<button type="button" class="destino-toggle" data-destino-toggle="true" aria-expanded="false">${summary}</button>
							<div class="destino-details" aria-hidden="true">${stackedFields}</div>
						</div>
					`;
				};

				const renderDelete = () =>
					`<button type="button" class="danger" data-logistica-delete="true">Eliminar</button>`;

				const renderCells = (cells) =>
					cells
						.map((cell, index) => {
							const columnKey = logisticaColumnKeys[index] || "";
							const shouldHide = logisticaHideableKeys.has(columnKey);
							const hiddenClass = shouldHide && columnsHidden ? " hidden-column" : "";
							const hideAttr = shouldHide ? " data-hide=\"true\"" : "";
							const printHideClass = pdfColumnKeys.has(columnKey)
								? ""
								: " print-hide";
							const isStacked = stackedColumnKeys.has(columnKey);
							const input = isStacked
								? renderStackedInputs(cell.value, cell.list || "", columnKey)
								: renderInput(cell.value, cell.list || "");
							const printOnly =
								columnKey === "economico"
									? `<div class="print-only">${escapeText(cell.value)}</div>`
									: "";
							return `<td${hideAttr} class="col-${columnKey}${printHideClass}${hiddenClass}">${input}${printOnly}</td>`;
						})
						.join("");

				const renderActionCell = () =>
					`<td class="print-hide">${renderDelete()}</td>`;

				const headerClass = (key, baseClass) =>
					`${baseClass}${pdfColumnKeys.has(key) ? "" : " print-hide"}`;

				const renderTableHeader = () => `
					<thead>
						<tr>
							<th data-column="fecha" data-secondary="true" class="${headerClass("fecha", "col-fecha")}" title="Ocultar columna">Fecha</th>
							<th data-column="destino" class="${headerClass("destino", "col-destino")}" title="Ocultar columna">Destino</th>
							<th data-column="ordenCarga" data-extra="true" class="${headerClass("ordenCarga", "col-ordenCarga")}" title="Ocultar columna">Orden de carga</th>
							<th data-column="almacen" data-secondary="true" class="${headerClass("almacen", "col-almacen")}" title="Ocultar columna">Almac√©n</th>
							<th data-column="cantidadAuto" data-extra="true" class="${headerClass("cantidadAuto", "col-cantidadAuto")}" title="Ocultar columna">Cant. Auto</th>
							<th data-column="cantidadCamion" data-extra="true" class="${headerClass("cantidadCamion", "col-cantidadCamion")}" title="Ocultar columna">Cant. Cami√≥n</th>
							<th data-column="otras" data-extra="true" class="${headerClass("otras", "col-otras")}" title="Ocultar columna">Otras</th>
							<th data-column="economico" class="${headerClass("economico", "col-economico")}" title="Ocultar columna">Econ√≥mico</th>
							<th data-column="empezar" data-extra="true" class="${headerClass("empezar", "col-empezar")}" title="Ocultar columna">Empezar a cargar</th>
							<th data-column="ubicacion" data-secondary="true" data-hide="true" class="${headerClass("ubicacion", "col-ubicacion")}" title="Ocultar columna">Ubicaci√≥n</th>
							<th data-column="coordenadas" data-secondary="true" data-hide="true" class="${headerClass("coordenadas", "col-coordenadas")}" title="Ocultar columna">Coordenadas</th>
							<th data-column="llantas" class="${headerClass("llantas", "col-llantas")}" title="Ocultar columna">Llantas</th>
							<th data-column="unidad" data-hide="true" class="${headerClass("unidad", "col-unidad")}" title="Ocultar columna">Unidad</th>
							<th data-column="operador" data-secondary="true" data-hide="true" class="${headerClass("operador", "col-operador")}" title="Ocultar columna">Operador</th>
							<th data-column="acompanante" data-extra="true" data-hide="true" class="${headerClass("acompanante", "col-acompanante")}" title="Ocultar columna">Acompa√±ante</th>
							<th data-column="cartaPorte" data-extra="true" class="${headerClass("cartaPorte", "col-cartaPorte")}" title="Ocultar columna">Carta porte</th>
							<th data-column="factura" data-extra="true" class="${headerClass("factura", "col-factura")}" title="Ocultar columna">Factura</th>
							<th data-column="traspaso" data-extra="true" class="${headerClass("traspaso", "col-traspaso")}" title="Ocultar columna">Traspaso</th>
							<th data-extra="true" class="print-hide">Acciones</th>
						</tr>
					</thead>
				`;

				const mergeRowsForDate = (dateRows, fallbackDate) => {
					const grouped = new Map();
					dateRows.forEach((row) => {
						const key = [row.destino, row.ubicacion, row.coordenadas, row.almacen]
							.map((value) => (value || "").trim().toLowerCase())
							.join("||");
						if (!grouped.has(key)) {
							grouped.set(key, {
								fecha: row.fecha || fallbackDate,
								almacen: row.almacen || "",
								destino: row.destino || "",
								ubicacion: row.ubicacion || "",
								coordenadas: row.coordenadas || "",
								cantidadAuto: row.cantidadAuto || "",
								cantidadCamion: row.cantidadCamion || "",
								otras: row.otras || "",
								acompanante: row.acompanante || "",
								ordenCarga: row.ordenCarga || "",
								empezar: row.empezar || "",
								cartaPorte: row.cartaPorte || "",
								factura: row.factura || "",
								traspaso: row.traspaso || "",
								unidades: [],
							});
						}
						const current = grouped.get(key);
						current.unidades.push({
							economico: row.economico || "",
							unidad: row.unidad || "",
							operador: row.operador || "",
						});
					});

					const mergeByUnidad = new Map();

					const addUnique = (list, value) => {
						const clean = (value || "").trim();
						if (!clean) return;
						if (!list.includes(clean)) list.push(clean);
					};

					const getAlmacenValues = (value) => {
						const clean = (value || "").trim();
						if (!clean) return [];
						const digits = clean.match(/\d+/g);
						if (digits && digits.length > 0) return digits;
						return [clean];
					};

					Array.from(grouped.values()).forEach((row) => {
					const rowEconomicos = uniqueLine(row.unidades.map((u) => u.economico));
					const rowUnidades = uniqueLine(row.unidades.map((u) => u.unidad));
					const rowOperadores = uniqueLine(row.unidades.map((u) => u.operador));
					const baseKey = [
						row.fecha,
						row.destino,
						row.ubicacion,
						row.coordenadas,
						row.almacen,
					]
						.map((value) => (value || "").trim().toLowerCase())
						.join("||");

					if (rowUnidades.length === 0 && rowEconomicos.length === 0) {
						const key = `destino:${baseKey}`;
						if (!mergeByUnidad.has(key)) {
							mergeByUnidad.set(key, {
								fecha: row.fecha || "",
								almacenes: [],
								destinos: [],
								ubicaciones: [],
								coordenadas: [],
								cantidadAuto: [],
								cantidadCamion: [],
								otras: [],
								llantas: [],
								economicos: [],
								unidades: [],
								operadores: [],
								acompanantes: [],
								ordenCarga: [],
								cartaPorte: [],
								factura: [],
								traspaso: [],
								empezar: [],
							});
						}
						const entry = mergeByUnidad.get(key);
						if (!entry.fecha && row.fecha) entry.fecha = row.fecha;
						getAlmacenValues(row.almacen).forEach((value) =>
							addUnique(entry.almacenes, value)
						);
						addUnique(entry.destinos, row.destino);
						addUnique(entry.ubicaciones, row.ubicacion);
						addUnique(entry.coordenadas, row.coordenadas);
						addUnique(entry.cantidadAuto, row.cantidadAuto);
						addUnique(entry.cantidadCamion, row.cantidadCamion);
						addUnique(entry.otras, row.otras);
						addUnique(entry.llantas, row.llantas);
						addUnique(entry.acompanantes, row.acompanante);
						addUnique(entry.ordenCarga, row.ordenCarga);
						addUnique(entry.cartaPorte, row.cartaPorte);
						addUnique(entry.factura, row.factura);
						addUnique(entry.traspaso, row.traspaso);
						addUnique(entry.empezar, row.empezar);
						return;
					}

					const unitKey = [rowEconomicos.join("|"), rowUnidades.join("|"), rowOperadores.join("|")]
						.map((value) => (value || "").trim().toLowerCase())
						.join("||");
					const key = `unidad:${unitKey || baseKey}`;
					if (!mergeByUnidad.has(key)) {
						mergeByUnidad.set(key, {
							fecha: row.fecha || "",
							almacenes: [],
							destinos: [],
							ubicaciones: [],
							coordenadas: [],
							cantidadAuto: [],
							cantidadCamion: [],
							otras: [],
							llantas: [],
							economicos: [],
							unidades: [],
							operadores: [],
							acompanantes: [],
							ordenCarga: [],
							cartaPorte: [],
							factura: [],
							traspaso: [],
								empezar: [],
							});
					}

					const entry = mergeByUnidad.get(key);
					if (!entry.fecha && row.fecha) entry.fecha = row.fecha;
					getAlmacenValues(row.almacen).forEach((value) =>
						addUnique(entry.almacenes, value)
					);
					addUnique(entry.destinos, row.destino);
					addUnique(entry.ubicaciones, row.ubicacion);
					addUnique(entry.coordenadas, row.coordenadas);
					addUnique(entry.cantidadAuto, row.cantidadAuto);
					addUnique(entry.cantidadCamion, row.cantidadCamion);
					addUnique(entry.otras, row.otras);
					addUnique(entry.llantas, row.llantas);
					rowEconomicos.forEach((value) => addUnique(entry.economicos, value));
					rowUnidades.forEach((value) => addUnique(entry.unidades, value));
					rowOperadores.forEach((value) => addUnique(entry.operadores, value));
					addUnique(entry.acompanantes, row.acompanante);
					addUnique(entry.ordenCarga, row.ordenCarga);
					addUnique(entry.cartaPorte, row.cartaPorte);
					addUnique(entry.factura, row.factura);
					addUnique(entry.traspaso, row.traspaso);
					addUnique(entry.empezar, row.empezar);
					});

					const sumList = (list) =>
						(list || []).reduce((total, value) => total + sumNumbers(value), 0);

					const mergedRows = Array.from(mergeByUnidad.values());
					const bodyRows = mergedRows
						.map((row) => {
							const llantasTotal =
								sumList(row.cantidadAuto) +
								sumList(row.cantidadCamion) +
								sumList(row.otras);
							const llantasValue =
								row.llantas && row.llantas.length > 0
									? joinInline(row.llantas)
									: llantasTotal > 0
										? String(llantasTotal)
										: "";
							const cells = [
								{ value: row.fecha || "" },
								{ value: joinInline(row.destinos) },
								{ value: joinInline(row.ordenCarga) },
								{ value: joinInline(row.almacenes) },
								{ value: joinInline(row.cantidadAuto) },
								{ value: joinInline(row.cantidadCamion) },
								{ value: joinInline(row.otras) },
								{ value: joinInline(row.economicos), list: "economicoOpciones" },
								{ value: joinInline(row.empezar) },
								{ value: joinInline(row.ubicaciones) },
								{ value: joinInline(row.coordenadas) },
								{ value: llantasValue },
								{ value: joinInline(row.unidades), list: "unidadOpciones" },
								{ value: joinInline(row.operadores), list: "operadorOpciones" },
								{ value: joinInline(row.acompanantes) },
								{ value: joinInline(row.cartaPorte) },
								{ value: joinInline(row.factura) },
								{ value: joinInline(row.traspaso) },
							];
							return `<tr>${renderCells(cells)}${renderActionCell()}</tr>`;
						})
						.join("");

					return bodyRows;
				};

				if (groupedByDate.size === 0) {
					const emptyCells = Array.from(
						{ length: logisticaColumnKeys.length },
						() => ({ value: "" })
					);
					const emptyBody = `<tbody><tr>${renderCells(emptyCells)}${renderActionCell()}</tr>${renderCommentRow(dateLabel, [])}</tbody>`;
					logisticaLists.innerHTML = `
						<details class="accordion-item">
							<summary><div class="accordion-summary">Log√≠stica</div></summary>
							<div class="accordion-content">
								<button type="button" class="conboy-fab" data-conboy-open="true" data-conboy-fecha="${escapeAttr(dateLabel)}" data-conboy-fecha-label="${escapeAttr(dateLabel)}">CONBOY</button>
								<div class="table-wrap">
									<table class="logistica-table">${renderTableHeader()}${emptyBody}</table>
								</div>
							</div>
						</details>
					`;
					applyLogisticaColumnVisibility();
					updateLogisticaColumnSummary();
					autoResizeLogisticaTextareas();
					return;
				}

				const detailsBlocks = Array.from(groupedByDate.entries())
					.map(([fecha, dateRows]) => {
						const bodyRows = mergeRowsForDate(dateRows, fecha || numericDate);
						const commentRow = renderCommentRow(fecha || numericDate, dateRows);
						return `
							<details class="accordion-item" data-fecha="${escapeAttr(fecha)}" data-fecha-label="${escapeAttr(getDateLabel(fecha))}">
								<summary>
									<div class="accordion-summary">Log√≠stica ¬∑ ${getDateLabel(fecha)}</div>
								</summary>
								<div class="accordion-content">
									<button type="button" class="conboy-fab" data-conboy-open="true" data-conboy-fecha="${escapeAttr(fecha)}" data-conboy-fecha-label="${escapeAttr(getDateLabel(fecha))}">CONBOY</button>
									<div class="table-wrap">
										<table class="logistica-table">${renderTableHeader()}<tbody>${bodyRows}${commentRow}</tbody></table>
									</div>
								</div>
							</details>
						`;
					})
					.join("");

				logisticaLists.innerHTML = detailsBlocks;
				applyLogisticaColumnVisibility();
				updateLogisticaColumnSummary();
				autoResizeLogisticaTextareas();
				applyLogisticaSearch(logisticaSearchInput?.value || "");
				renderConboyPrintSummary(rows);
			};

			const autoResizeLogisticaTextareas = () => {
				getLogisticaBodies().forEach((body) => {
					body.querySelectorAll("textarea").forEach((textarea) => {
						textarea.style.height = "auto";
						textarea.style.height = `${textarea.scrollHeight}px`;
					});
				});
			};

			const applyDestinoPrintTruncate = () => {
				getLogisticaBodies().forEach((body) => {
					body.querySelectorAll(".destino-compact").forEach((wrapper) => {
						if (wrapper.classList.contains("is-open")) return;
						wrapper.dataset.printWasClosed = "true";
						wrapper.classList.add("is-open");
						const toggle = wrapper.querySelector("[data-destino-toggle='true']");
						if (toggle) toggle.setAttribute("aria-expanded", "true");
						const details = wrapper.querySelector(".destino-details");
						if (details) details.setAttribute("aria-hidden", "false");
					});
				});
			};

			const restoreDestinoAfterPrint = () => {
				getLogisticaBodies().forEach((body) => {
					body.querySelectorAll(".destino-compact").forEach((wrapper) => {
						if (wrapper.dataset.printWasClosed !== "true") return;
						wrapper.classList.remove("is-open");
						delete wrapper.dataset.printWasClosed;
						const toggle = wrapper.querySelector("[data-destino-toggle='true']");
						if (toggle) toggle.setAttribute("aria-expanded", "false");
						const details = wrapper.querySelector(".destino-details");
						if (details) details.setAttribute("aria-hidden", "true");
					});
				});
				autoResizeLogisticaTextareas();
			};

			addRowButton.addEventListener("click", () => addRow());
			saveDraftButton.addEventListener("click", async () => {
				try {
					await saveBorradorToApi();
					alert("Borrador guardado en la base.");
				} catch (error) {
					console.error("No se pudo guardar el borrador", error);
					alert("No se pudo guardar el borrador.");
				}
			});

			tabBorrador.addEventListener("click", () => switchTab("borrador"));
			tabLogistica.addEventListener("click", () => {
				renderLogistica(getLogisticaRowsForView());
				switchTab("logistica");
			});

			showLogisticaColumnsButton?.addEventListener("click", () => {
				const isOpen = logisticaColumnPanel?.classList.toggle("open");
				if (logisticaColumnPanel) {
					logisticaColumnPanel.setAttribute("aria-hidden", String(!isOpen));
				}
				showLogisticaColumnsButton.textContent = isOpen
					? "Ocultar lista"
					: "Mostrar columnas";
				if (isOpen) {
					renderLogisticaColumnToggles();
				}
			});

			logisticaSaveChangesButton?.addEventListener("click", async () => {
				const saved = await saveLogisticaChanges();
				if (saved) {
					alert("Cambios guardados en la base.");
				}
			});

			const handleLogisticaSearch = () => {
				applyLogisticaSearch(logisticaSearchInput?.value || "");
			};

			logisticaSearchButton?.addEventListener("click", handleLogisticaSearch);
			logisticaSearchInput?.addEventListener("input", handleLogisticaSearch);

			printLogisticaButton.addEventListener("click", () => {
				const tableRows = getLogisticaRowsFromTable().filter((row) =>
					hasLogisticaRowContent(row)
				);
				renderLogistica(tableRows.length > 0 ? tableRows : getLogisticaRowsForView());
				switchTab("logistica");
				setTimeout(() => {
					applyDestinoPrintTruncate();
					window.print();
				}, 100);
			});

			window.addEventListener("beforeprint", () => {
				applyDestinoPrintTruncate();
			});

			window.addEventListener("afterprint", () => {
				restoreDestinoAfterPrint();
			});

			const STORAGE_CONBOY = "cubicaje-conboy-grupos";

			const formatUnitLabel = (unit) => {
				const parts = [];
				if (unit.economico) parts.push(`ECO ${unit.economico}`);
				if (unit.unidad) parts.push(`UNI ${unit.unidad}`);
				if (unit.operador) parts.push(`OP ${unit.operador}`);
				return parts.join(" ¬∑ ") || "Unidad";
			};

			const normalizeUnitKey = (unit) =>
				[unit.economico, unit.unidad, unit.operador]
					.map((value) => normalizeSearchValue(value || ""))
					.join("||");

			const buildConboyUnits = (rows) => {
				const map = new Map();
				rows.forEach((row) => {
					const unit = {
						economico: String(row.economico || "").trim(),
						unidad: String(row.unidad || "").trim(),
						operador: String(row.operador || "").trim(),
						ubicacion: String(row.ubicacion || "").trim(),
					};
					if (!unit.economico && !unit.unidad && !unit.operador) return;
					const key = normalizeUnitKey(unit);
					if (!map.has(key)) map.set(key, unit);
				});
				return Array.from(map.values());
			};

			const getConboyRowsForDate = (rawDate, labelDate) => {
				const rows = getLogisticaRowsForView();
				const normalized = normalizeSearchValue(rawDate || labelDate || "");
				if (!normalized) return rows;
				const fallbackDate = new Date().toLocaleDateString("es-MX");
				return rows.filter((row) => {
					const rowDate = String(row.fecha || fallbackDate).trim() || fallbackDate;
					const rowRaw = normalizeSearchValue(rowDate);
					const rowLabel = normalizeSearchValue(getDateLabel(rowDate));
					return rowRaw === normalized || rowLabel === normalized;
				});
			};

			const getConboyStore = () => {
				try {
					const raw = localStorage.getItem(STORAGE_CONBOY);
					const parsed = raw ? JSON.parse(raw) : {};
					return parsed && typeof parsed === "object" ? parsed : {};
				} catch (error) {
					console.warn("No se pudo leer CONBOY", error);
					return {};
				}
			};

			const saveConboyStore = (store) => {
				localStorage.setItem(STORAGE_CONBOY, JSON.stringify(store));
			};

			const conboyState = {
				dateKey: "",
				dateLabel: "",
				units: [],
				groups: [],
				activeGroupId: null,
			};

			const persistConboyState = () => {
				if (!conboyState.dateKey) return;
				const store = getConboyStore();
				store[conboyState.dateKey] = conboyState.groups;
				saveConboyStore(store);
			};

			const escapeConboyText = (value) =>
				String(value)
					.replace(/&/g, "&amp;")
					.replace(/</g, "&lt;")
					.replace(/>/g, "&gt;");

			const renderConboy = () => {
				if (!conboyAvailableUnits || !conboyGroups) return;
				if (conboyState.units.length === 0) {
					conboyAvailableUnits.innerHTML = "No hay unidades para esta fecha.";
				} else {
					conboyAvailableUnits.innerHTML = conboyState.units
						.map((unit, index) => {
							const ubicacionLabel = unit.ubicacion || "Sin ubicacion";
							const meta = [
								unit.economico ? `ECO ${unit.economico}` : "",
								unit.operador ? `OP ${unit.operador}` : "",
							]
								.filter(Boolean)
								.join(" ¬∑ ");
							return `
								<button type="button" class="conboy-unit" data-conboy-unit-index="${index}">
									<span>${ubicacionLabel}</span>
									<span class="conboy-unit-meta">${meta}</span>
								</button>
							`;
						})
						.join("");
				}

				if (conboyState.groups.length === 0) {
					conboyGroups.innerHTML = "Crea un grupo para empezar.";
					return;
				}

				conboyGroups.innerHTML = conboyState.groups
					.map((group) => {
						const isActive = group.id === conboyState.activeGroupId;
						const chips = (group.units || [])
							.map((unit, index) => {
								const label = formatUnitLabel(unit);
								return `
									<span class="conboy-chip">
										${label}
										<button type="button" data-conboy-remove="true" data-group-id="${group.id}" data-unit-index="${index}">x</button>
									</span>
								`;
							})
							.join("") || "Sin unidades";
						return `
							<div class="conboy-group${isActive ? " active" : ""}" data-group-id="${group.id}">
								<div class="conboy-group-header">
									<button type="button" class="secondary" data-conboy-group-rename="true" data-group-id="${group.id}">${group.name}</button>
									<button type="button" class="secondary" data-conboy-group-select="true" data-group-id="${group.id}">Usar</button>
									<button type="button" class="danger" data-conboy-group-remove="true" data-group-id="${group.id}">Eliminar</button>
								</div>
								<div>${chips}</div>
								<textarea class="conboy-group-note" data-conboy-group-note="true" data-group-id="${group.id}" placeholder="Comentario del grupo...">${escapeConboyText(group.note || "")}</textarea>
							</div>
						`;
					})
					.join("");
			};

			const createConboyGroup = () => {
				const nextId = Date.now();
				const index = conboyState.groups.length + 1;
				conboyState.groups.push({
					id: nextId,
					name: `Grupo ${index}`,
					units: [],
					note: "",
				});
				conboyState.activeGroupId = nextId;
				persistConboyState();
				renderConboy();
			};

			const addUnitToActiveGroup = (unit) => {
				if (!unit) return;
				if (!conboyState.activeGroupId) {
					createConboyGroup();
				}
				const group = conboyState.groups.find(
					(item) => item.id === conboyState.activeGroupId
				);
				if (!group) return;
				const key = normalizeUnitKey(unit);
				const exists = group.units.some(
					(item) => normalizeUnitKey(item) === key
				);
				if (!exists) {
					group.units.push(unit);
					persistConboyState();
					renderConboy();
				}
			};

			const openConboyModal = (fechaRaw, fechaLabel) => {
				if (!conboyModal) return;
				conboyModal.classList.add("is-open");
				conboyModal.setAttribute("aria-hidden", "false");
				const label = String(fechaLabel || "").trim();
				const raw = String(fechaRaw || "").trim();
				conboyState.dateLabel = label || raw;
				conboyState.dateKey = normalizeSearchValue(raw || label || "");
				const rowsForDate = getConboyRowsForDate(raw, label);
				conboyState.units = buildConboyUnits(rowsForDate);
				const store = getConboyStore();
				conboyState.groups = Array.isArray(store[conboyState.dateKey])
					? store[conboyState.dateKey]
					: [];
				conboyState.activeGroupId = conboyState.groups[0]?.id || null;
				if (conboyDateLabel) {
					conboyDateLabel.textContent = conboyState.dateLabel
						? `¬∑ ${conboyState.dateLabel}`
						: "";
				}
				renderConboy();
			};

			const closeConboyModal = () => {
				if (!conboyModal) return;
				conboyModal.classList.remove("is-open");
				conboyModal.setAttribute("aria-hidden", "true");
			};

			conboyClose?.addEventListener("click", closeConboyModal);
			conboyModal?.addEventListener("click", (event) => {
				if (event.target === conboyModal) {
					closeConboyModal();
				}
			});

			conboyAddGroup?.addEventListener("click", () => createConboyGroup());
			conboyClear?.addEventListener("click", () => {
				conboyState.groups = [];
				conboyState.activeGroupId = null;
				persistConboyState();
				renderConboy();
			});
			conboyApply?.addEventListener("click", () => {
				persistConboyState();
				closeConboyModal();
			});

			conboyAvailableUnits?.addEventListener("click", (event) => {
				const target = event.target;
				if (!(target instanceof HTMLElement)) return;
				const button = target.closest("[data-conboy-unit-index]");
				if (!button) return;
				const index = Number(button.dataset.conboyUnitIndex || "-1");
				const unit = conboyState.units[index];
				addUnitToActiveGroup(unit);
			});

			conboyGroups?.addEventListener("dblclick", (event) => {
				const target = event.target;
				if (!(target instanceof HTMLElement)) return;
				const renameGroup = target.closest("[data-conboy-group-rename='true']");
				if (renameGroup) {
					const id = Number(renameGroup.dataset.groupId || "0");
					const group = conboyState.groups.find((g) => g.id === id);
					if (!group) return;
					const response = window.prompt("Nombre del grupo:", group.name);
					if (response === null) return;
					const cleaned = String(response).trim();
					if (!cleaned) return;
					group.name = cleaned;
					persistConboyState();
					renderConboy();
					return;
				}
			});

			conboyGroups?.addEventListener("click", (event) => {
				const target = event.target;
				if (!(target instanceof HTMLElement)) return;
				const select = target.closest("[data-conboy-group-select='true']");
				if (select) {
					const id = Number(select.dataset.groupId || "0");
					if (id) conboyState.activeGroupId = id;
					renderConboy();
					return;
				}
				const removeGroup = target.closest("[data-conboy-group-remove='true']");
				if (removeGroup) {
					const id = Number(removeGroup.dataset.groupId || "0");
					conboyState.groups = conboyState.groups.filter((g) => g.id !== id);
					if (conboyState.activeGroupId === id) {
						conboyState.activeGroupId = conboyState.groups[0]?.id || null;
					}
					persistConboyState();
					renderConboy();
					return;
				}
				const removeUnit = target.closest("[data-conboy-remove='true']");
				if (removeUnit) {
					const groupId = Number(removeUnit.dataset.groupId || "0");
					const unitIndex = Number(removeUnit.dataset.unitIndex || "-1");
					const group = conboyState.groups.find((g) => g.id === groupId);
					if (group && unitIndex > -1) {
						group.units.splice(unitIndex, 1);
						persistConboyState();
						renderConboy();
					}
				}
			});

			conboyGroups?.addEventListener("input", (event) => {
				const target = event.target;
				if (!(target instanceof HTMLTextAreaElement)) return;
				if (!target.matches("[data-conboy-group-note='true']")) return;
				const groupId = Number(target.dataset.groupId || "0");
				const group = conboyState.groups.find((g) => g.id === groupId);
				if (!group) return;
				group.note = target.value;
				persistConboyState();
			});

			logisticaLists?.addEventListener("click", async (event) => {
				const target = event.target;
				if (!(target instanceof HTMLElement)) return;
				const conboyTrigger = target.closest("[data-conboy-open='true']");
				if (conboyTrigger instanceof HTMLElement) {
					openConboyModal(
						conboyTrigger.dataset.conboyFecha || "",
						conboyTrigger.dataset.conboyFechaLabel || ""
					);
					return;
				}
				const destinoToggle = target.closest("[data-destino-toggle='true']");
				if (destinoToggle) {
					const wrapper = destinoToggle.closest(".destino-compact");
					if (!wrapper) return;
					const isOpen = wrapper.classList.toggle("is-open");
					destinoToggle.setAttribute("aria-expanded", String(isOpen));
					const details = wrapper.querySelector(".destino-details");
					if (details) details.setAttribute("aria-hidden", String(!isOpen));
					return;
				}
				const header = target.closest("th[data-column]");
				if (header) {
					const key = header.dataset.column;
					if (!key) return;
					if (logisticaHiddenColumns.has(key)) {
						logisticaHiddenColumns.delete(key);
					} else {
						logisticaHiddenColumns.add(key);
					}
					applyLogisticaColumnVisibility();
					renderLogistica(getLogisticaRowsForView());
					return;
				}
				if (target.matches("[data-logistica-delete='true']")) {
					const row = target.closest("tr");
					if (row) row.remove();
					await saveLogisticaChanges();
				}
			});

			logisticaLists?.addEventListener("input", (event) => {
				const target = event.target;
				if (target instanceof HTMLTextAreaElement) {
					target.style.height = "auto";
					target.style.height = `${target.scrollHeight}px`;
				}
				if (
					target instanceof HTMLTextAreaElement &&
					target.matches("[data-group-comment='true']")
				) {
					const key = target.dataset.fechaKey || "";
					logisticaGroupNotes.set(key, target.value || "");
				}
			});

			toggleColumnsButton.addEventListener("click", () => {
				const isOpen = borradorColumnPanel?.classList.toggle("open");
				if (borradorColumnPanel) {
					borradorColumnPanel.setAttribute("aria-hidden", String(!isOpen));
				}
				toggleColumnsButton.textContent = isOpen
					? "Ocultar lista de columnas"
					: "Mostrar columnas ocultas";
				if (isOpen) {
					renderBorradorColumnToggles();
				}
			});


			sendButton.addEventListener("click", async () => {
				const dateLabel = promptForLogisticaDate();
				if (!dateLabel) return;
				const rows = getCurrentRows().map((row) => ({
					...row,
					fecha: dateLabel,
				}));
				try {
					await sendRowsToSheet(SHEETDB_TAB_LOGISTICA, rows, null, {
						clearFirst: false,
					});
					await sendRowsToSheet(SHEETDB_TAB_BORRADOR, [], mapDataToSheetRowBorrador);
					await loadLogisticaData();
				} catch (error) {
					console.error("No se pudo guardar log√≠stica", error);
					alert(
						`No se pudo guardar en la base. ${error?.message || "Intenta de nuevo."}`
					);
					return;
				}
				localStorage.setItem(STORAGE_LOGISTICA, JSON.stringify(rows));
				renderLogistica(getLogisticaRowsForView());
				switchTab("logistica");
				tableBody.innerHTML = "";
				addRow();
				localStorage.removeItem(STORAGE_KEY);
			});

			clearButton.addEventListener("click", () => {
				if (!confirm("¬øSeguro que quieres borrar todas las filas?")) {
					return;
				}
				tableBody.innerHTML = "";
				addRow();
				saveData();
			});

			formatDate();
			applyBorradorColumnVisibility();
			renderBorradorColumnToggles();
			loadDestinoData();
			loadFlotaData();
			loadData().catch((error) => console.error("Error al cargar", error));
			loadLogisticaData().catch((error) =>
				console.error("Error al cargar log√≠stica", error)
			);
		</script>
	</body>
</html>
